<script type="text/javascript">
    const UPDATE_VISUALIZATION_INTERVAL_MS = 10000;
    const PHASE_VOLTAGE_THRESHOLD = 220;
</script>

<style type="text/css">
    .dashboard-container {
        display: grid;
        grid-template-columns: [col1] auto [col2] auto [col3] auto [col4] auto;
        grid-template-rows: [row1] auto [row2] auto;
        padding: 10px;
        text-align: left;
    }

    .dashboard-item {
        background-color:lightblue;
        margin: 8px;
        padding: 15px;
    }

    .power-characteristic {
        margin: 5px;
    }

    .status-indicator {
        display: inline-block;
        background-color: darkgreen;
        height: 1em;
        width: 1em;
        border-radius: 50%;
        margin-left: 0.25em;
        margin-right: 0.25em;
    }

    .valuebar {
        min-width: 100px;
        height: 8px;
        background-color: rgb(192, 192, 192);
        border: solid 1px black;
    }

    .valuebar-inner {
        background-color: green;
		height: 100%;
        width: 0%;
        float: left;
    }

    .overvaluebar-inner {
        background-color: orange;
		height: 100%;
        width: 0%;
        float: left;
    }

    .overvaluebar2-inner {
        background-color: crimson;
		height: 100%;
        width: 0%;
        float: left;
    }

    #heating-graph {
        border: 1px solid lightslategrey;
        background-color: white;
    }

    #faults-table {
        border: 1px solid lightslategrey;
    }

    #fault-indicator {
        background-color: crimson;
        border-style: none;
    }

    #ext-in-indicator {
        background-color: darkgoldenrod;
        border-style: none;
    }

    #ar-indicator {
        background-color: green;
        border-style: none;
    }

    #rc-indicator {
        background-color: dodgerblue;
        border-style: none;
    }

    #reset-fault-button {
        background-color: navajowhite;
    }

    #faults-table-container {
        min-width: 250px;
    }

    #faults-table tbody {
        background-color: white;
        height: 250px;
        overflow: auto;
        width: 100%;
    }

    #faults-table thead > tr, tbody { 
        display: block;
    }

    #faults-table td, th {
        border:1px solid black;
    }

    @media only screen and (max-device-width: 1100px) {
        .dashboard-container {
            display: grid;
            grid-template-columns: [col1] auto;
            grid-template-rows: repeat(8, auto [row]);
            padding: 10px;
        }

        .dashboard-item {
            background-color:lightblue;
            margin: 5px;
            padding: 15px;
        }

        .power-characteristic {
            padding: 10px;
        }
    }

    .dashboard-container header {
        text-align: center;
    }
</style>

<div id="ubz-vis-container">
    <alias device="#16" name="ubz"></alias>
    <header>UBZ-302 Control Panel</header>

    <div class="dashboard-container">
        <div class="dashboard-item">
            <header>UBZ Status</header>
            <div><span class="status-indicator" id="mmsp-mode"></span>MMSP</div>
            <div><span class="status-indicator" id="functional-relay-mode"></span>Functional relay</div>
            <div><span class="status-indicator" id="motor-relay-mode"></span>Motor relay</div>
            <p>Functional relay work mode</p>
            <form id="functional-relay-work-mode-radio">
                <input type="radio" id="radio-workmode-alarm" name="func-relay-workmode" value="alarmrelay">
                <label for="radio-workmode-alarm">Alarm relay</label><br>
                <input type="radio" id="radio-workmode-time" name="func-relay-workmode" value="timerelay">
                <label for="radio-workmode-time">Time relay</label><br>
                <input type="radio" id="radio-workmode-stardelta" name="func-relay-workmode" value="stardelta">
                <label for="radio-workmode-stardelta">Star / delta</label><br>
            </form>
        </div>
        <div class="dashboard-item">
            <div>
                <header>UBZ Fault Status</header>
                <button id="fault-indicator" disabled>Fault</button>
                <button id="ext-in-indicator" disabled>Ext. in.</button>
                <button id="ar-indicator" disabled>AR</button>
                <button id="rc-indicator" disabled>RC</button>
                <button id="reset-fault-button">Reset Fault</button>
            </div>
            <div id="faults-table-container">
                <table id="faults-table">
                    <tr>
                        <th>
                            Name
                        </th>
                        <th>
                            ###
                        </th>
                        <th>
                            Value
                        </th>
                        <th>
                            Time
                        </th>
                    </tr>
                </table>
            </div>
        </div>
        <div class="dashboard-item">
            <header>Heating</header>
            <div>
                <canvas id="heating-graph" width="auto" height="auto"></canvas>
            </div>
        </div>
        <div class="dashboard-item">
            <header>Status of communication with UBZ</header>
            <ul>
                <li>Activity:</li>
                <li>Status: <span id="connection-status-string">Unknown</span></li>
                <li>Speed: <span id="speed-value">0</span> bps</li>
                <li>Connecting time: <span id="connecting-time-string">00:00:00</span></li>
                <li>Address UBZ: <input type="number" min="1" max="247" value="1" id="modbus-address-ubz" name="modbus-address-ubz"></li>
            </ul>
        </div>
        <div class="dashboard-item">
            <header>Current (Ampere)</header>
                <div>
                    <p>Phase currents active values:</p>
                    <ul>
                        <li>Phase1: <div class="valuebar" id="phase-1-current-rms-bar" value="0">
                            <div class="valuebar-inner" id="phase-1-current-rms-bar-inner"></div>
                        </div> <span id="phase-1-current-rms-value">0.0</span> A</li>
                        <li>Phase2: <div class="valuebar" id="phase-2-current-rms-bar" value="0">
                            <div class="valuebar-inner" id="phase-2-current-rms-bar-inner"></div>
                        </div> <span id="phase-2-current-rms-value">0.0</span> A</li>
                        <li>Phase3: <div class="valuebar" id="phase-3-current-rms-bar" value="0">
                            <div class="valuebar-inner" id="phase-3-current-rms-bar-inner"></div>
                        </div> <span id="phase-3-current-rms-value">0.0</span> A</li>
                    </ul>
                </div>
                <div>
                    <p>Negative sequence current:</p>
                    <div class="valuebar" id="negative-sequence-current-bar" value="0">
                        <div class="valuebar-inner" id="negative-sequence-current-bar-inner"></div>
                    </div> <span id="negative-sequence-current-value">0.0</span> A
                </div>
                <div>
                    <p>Zero sequence current:</p>
                    <div class="valuebar" id="zero-sequence-current-bar" value="0">
                        <div class="valuebar-inner" id="zero-sequence-current-bar-inner"></div>
                    </div> <span id="zero-sequence-current-value">0.0</span> A
                </div>

                <div>
                    <table>
                        <tr>
                            <th>Current average value:</th>
                            <th>For time</th>
                            <th>Max:</th>
                        </tr>
                        <tr>
                            <td>Phase 1:</td>
                            <td rowspan="3">
                                <span id="current-average-for-time-value">60.0</span> sec
                            </td>
                            <td><span id="avg-current-value-phase-1">0.0</span> A</td>
                        </tr>
                        <tr>
                            <td>Phase 2:</td>
                            <td><span id="avg-current-value-phase-2">0.0</span> A</td>
                        </tr>
                        <tr>
                            <td>Phase 3:</td>
                            <td><span id="avg-current-value-phase-3">0.0</span> A</td>
                        </tr>
                    </table>
                </div>
                <div>
                    <ul>
                        <li>Motor start current: <span id="motor-start-current-value">0.0</span> A</li>
                        <li>Overload current: <span id="overload-current-value">0.0</span> A</li>
                    </ul>
                </div>
        </div>
        <div class="dashboard-item">
            <header>Voltage (Volt)</header>
                <div>
                    <p>Phase voltages active values:</p>
                    <ul>
                        <li>Phase1: <div class="valuebar" id="phase-1-voltage-bar" value="0">
                            <div class="valuebar-inner" id="phase-1-voltage-bar-inner"></div>
                            <div class="overvaluebar-inner" id="phase-1-voltage-bar-over-inner"></div>
                        </div> <span id="phase-1-voltage-value">0.0</span> V</li>
                        <li>Phase2: <div class="valuebar" id="phase-2-voltage-bar" value="0">
                            <div class="valuebar-inner" id="phase-2-voltage-bar-inner"></div>
                            <div class="overvaluebar-inner" id="phase-2-voltage-bar-over-inner"></div>
                        </div> <span id="phase-2-voltage-value">0.0</span> V</li>
                        <li>Phase3: <div class="valuebar" id="phase-3-voltage-bar" value="0">
                            <div class="valuebar-inner" id="phase-3-voltage-bar-inner"></div>
                            <div class="overvaluebar-inner" id="phase-3-voltage-bar-over-inner"></div>
                        </div> <span id="phase-3-voltage-value">0.0</span> V</li>
                    </ul>
                </div>
                <div>
                    <p>Line voltages active values:</p>
                    <ul>
                        <li>AB:
                            <div class="valuebar" id="line-1-voltage-bar" value="0">
                                <div class="valuebar-inner" id="line-1-voltage-bar-inner"></div>
                                <div class="overvaluebar-inner" id="line-1-voltage-bar-over-inner"></div>
                                <div class="overvaluebar2-inner" id="line-1-voltage-bar-over2-inner"></div>
                            </div>
                            <span id="line-1-voltage-value">0.0</span> V</li>
                        <li>BC:
                            <div class="valuebar" id="line-2-voltage-bar" value="0">
                                <div class="valuebar-inner" id="line-2-voltage-bar-inner"></div>
                                <div class="overvaluebar-inner" id="line-2-voltage-bar-over-inner"></div>
                                <div class="overvaluebar2-inner" id="line-2-voltage-bar-over2-inner"></div>
                            </div>
                            <span id="line-2-voltage-value">0.0</span> V</li>
                        <li>CA:
                            <div class="valuebar" id="line-3-voltage-bar" value="0">
                                <div class="valuebar-inner" id="line-3-voltage-bar-inner"></div>
                                <div class="overvaluebar-inner" id="line-3-voltage-bar-over-inner"></div>
                                <div class="overvaluebar2-inner" id="line-3-voltage-bar-over2-inner"></div>
                            </div>
                            <span id="line-3-voltage-value">0.0</span> V</li>
                    </ul>
                </div>

                <p>
                    Negative sequence voltage:
                    <div>
                        <div class="valuebar" id="negative-sequence-voltage-bar" value="0">
                            <div class="valuebar-inner" id="negative-sequence-voltage-bar-inner"></div>
                        </div> <span id="negative-sequence-voltage-value">0.0</span> V
                    </div>
                </p>

                <p>
                    Positive sequence voltage: <span id="positive-sequence-voltage-value">0</span> V
                </p>
                <p>
                    Zero sequence voltage: <span id="zero-sequence-voltage-value">0</span> V
                </p>
        </div>
        <div class="dashboard-item">
            <header>Time (sec)</header>
                <div>
                    <p>Time before AR:</p>
                    <div class="valuebar" id="time-before-ar-bar" value="0">
                        <div class="valuebar-inner" id="time-before-ar-bar-inner"></div>
                    </div> <span id="time-before-ar-string"> Off</span>
                </div>
                <ul>
                    <li>Startup time: <span id="startup-time-value">0</span> sec</li>
                    <li>Time before overload tripping: <span id="time-before-overload-tripping-string">No</span></li>
                    <li>Wait time after overload deenergize: <span id="wait-time-after-overload-deenergize-string">No</span></li>
                </ul>

                <header>Power</header>
                <ul>
                    <li>
                        <select id="power-characteristic-value-1" class="power-characteristic" name="power-characteristic-value-1">
                            <option value="full-power">Full power</option>
                            <option value="active-power">Active power</option>
                            <option value="reactive-power">Reactive power</option>
                            <option value="phase-1-full-power">Phase 1 full power</option>
                            <option value="phase-2-full-power">Phase 2 full power</option>
                            <option value="phase-3-full-power">Phase 3 full power</option>
                            <option value="phase-1-active-power">Phase 1 active power</option>
                            <option value="phase-2-active-power">Phase 2 active power</option>
                            <option value="phase-3-active-power">Phase 3 active power</option>
                            <option value="phase-1-reactive-power">Phase 1 reactive power</option>
                            <option value="phase-2-reactive-power">Phase 2 reactive power</option>
                            <option value="phase-3-reactive-power">Phase 3 reactive power</option>
                            <option value="phase-1-cos-phi">Phase 1 cos Phi</option>
                            <option value="phase-2-cos-phi">Phase 2 cos Phi</option>
                            <option value="phase-3-cos-phi">Phase 3 cos Phi</option>
                        </select>
                        <span id="power-show-value-1">
                            -
                        </span>
                    </li>
                    <li>
                        <select id="power-characteristic-value-2" class="power-characteristic" name="power-characteristic-value-2">
                            <option value="full-power">Full power</option>
                            <option value="active-power">Active power</option>
                            <option value="reactive-power">Reactive power</option>
                            <option value="phase-1-full-power">Phase 1 full power</option>
                            <option value="phase-2-full-power">Phase 2 full power</option>
                            <option value="phase-3-full-power">Phase 3 full power</option>
                            <option value="phase-1-active-power">Phase 1 active power</option>
                            <option value="phase-2-active-power">Phase 2 active power</option>
                            <option value="phase-3-active-power">Phase 3 active power</option>
                            <option value="phase-1-reactive-power">Phase 1 reactive power</option>
                            <option value="phase-2-reactive-power">Phase 2 reactive power</option>
                            <option value="phase-3-reactive-power">Phase 3 reactive power</option>
                            <option value="phase-1-cos-phi">Phase 1 cos Phi</option>
                            <option value="phase-2-cos-phi">Phase 2 cos Phi</option>
                            <option value="phase-3-cos-phi">Phase 3 cos Phi</option>
                        </select>
                        <span id="power-show-value-2">
                            -
                        </span>
                    </li>
                    <li>
                        <select id="power-characteristic-value-3" class="power-characteristic" name="power-characteristic-value-3">
                            <option value="full-power">Full power</option>
                            <option value="active-power">Active power</option>
                            <option value="reactive-power">Reactive power</option>
                            <option value="phase-1-full-power">Phase 1 full power</option>
                            <option value="phase-2-full-power">Phase 2 full power</option>
                            <option value="phase-3-full-power">Phase 3 full power</option>
                            <option value="phase-1-active-power">Phase 1 active power</option>
                            <option value="phase-2-active-power">Phase 2 active power</option>
                            <option value="phase-3-active-power">Phase 3 active power</option>
                            <option value="phase-1-reactive-power">Phase 1 reactive power</option>
                            <option value="phase-2-reactive-power">Phase 2 reactive power</option>
                            <option value="phase-3-reactive-power">Phase 3 reactive power</option>
                            <option value="phase-1-cos-phi">Phase 1 cos Phi</option>
                            <option value="phase-2-cos-phi">Phase 2 cos Phi</option>
                            <option value="phase-3-cos-phi">Phase 3 cos Phi</option>
                        </select>
                        <span id="power-show-value-3">
                            -
                        </span>
                    </li>
                </ul>
        </div>
        <div class="dashboard-item">
            <header>Additional</header>
                <ul>
                    <li>Sensor 1 temperature: <span id="sensor-1-temperature-value">Off</span></li>
                    <li>Sensor 2 temperature: <span id="sensor-2-temperature-value">Off</span></li>
                    <li>Current input: <span id="current-input-value">0.0</span> mA</li>
                    <li>Analog input: <span id="analog-input-value">0.0</span> V</li>
                    <li>Frequency: <span id="frequency-value">50.0</span> Hz</li>
                    <li>Insulation resistance: <span id="insulation-resistance-value">20.0</span> MOhm</li>
                </ul>
                <div><button id="motor-start-stop-button" disabled><img src = "https://cdn-icons-png.flaticon.com/512/2479/2479510.png" style="width: 100px;"></button></div>
                <button id="save-file-button">Save file</button>
        </div>
    </div>
</div>
<!--        <footer>
            <button>Connect</button>
            <button>Database</button>
            <button>Settings</button>
            <button>UBZ Parameters</button>
            <button>Log event UBZ</button>
            <button>About</button>
        </footer>-->


<script type="text/javascript">
    var canvas = document.querySelector("#heating-graph");
    var ctx = canvas.getContext("2d");
    ctx.font = "16px Droid Sans";

    var deviceConnected = false;
    var faultIndicatorSet = false;
    
    const API_TOKEN = document.querySelector(".vis-view").getAttribute("apitoken");
    const API_BASE_URL = document.querySelector(".vis-view").getAttribute("apibaseurl");
    const CONTAINER = document.querySelector("#ubz-vis-container");
    const DEVICE_ID = CONTAINER.querySelector("alias").getAttribute("device").replace("#", "");

    const alarms = [
        {
            name: "Phase overcurrent",
            mnemonic: "A,=",
            address: 241,
            bit: 0,
            valueAddress: 300,
        },
        {
            name: "Thermal overload",
            mnemonic: "Adt",
            address: 241,
            bit: 1,
            valueAddress: 301,
        },
        {
            name: "Ground fault (zero sequence current)",
            mnemonic: "A,_",
            address: 241,
            bit: 2,
            valueAddress: 302,
        },
        {
            name: "Exceeded multiplicity", // ???
            mnemonic: "A,O",
            address: 241,
            bit: 3,
            valueAddress: 303,
        },
        {
            name: "Negative sequence current",
            mnemonic: "A,o",
            address: 241,
            bit: 4,
            valueAddress: 304,
        },
        {
            name: "Phase undercurrent",
            mnemonic: "A,.",
            address: 241,
            bit: 5,
            valueAddress: 305,
        },
        {
            name: "Delayed start",
            mnemonic: "APP",
            address: 241,
            bit: 6,
            valueAddress: 306,
        },
        {
            name: "Rotor blocking",
            mnemonic: "APb",
            address: 241,
            bit: 7,
            valueAddress: 307,
        },
        {
            name: "Temperature threshold at sensor 1",
            mnemonic: "At1",
            address: 241,
            bit: 8,
            valueAddress: 308,
        },
        {
            name: "Temperature threshold at sensor 2",
            mnemonic: "At2",
            address: 241,
            bit: 9,
            valueAddress: 309,
        },
        {
            name: "Phase sequence",
            mnemonic: "AUЧ",
            address: 241,
            bit: 10,
            valueAddress: 310,
        },
        {
            name: "External MS",
            mnemonic: "ACo",
            address: 241,
            bit: 11,
            valueAddress: 311,
        },
        {
            name: "Line undervoltage",
            mnemonic: "AU.",
            address: 241,
            bit: 12,
            valueAddress: 312,
        },
        {
            name: "Line overvoltage",
            mnemonic: "AU=",
            address: 241,
            bit: 13,
            valueAddress: 313,
        },
        {
            name: "Phase imbalance",
            mnemonic: "AU'",
            address: 241,
            bit: 14,
            valueAddress: 314,
        },
        {
            name: "Motor coil insulation resistance",
            mnemonic: "Ar,",
            address: 241,
            bit: 15,
            valueAddress: 315,
        },
        {
            name: "Remote control channel fault",
            mnemonic: "AdU",
            address: 242,
            bit: 0,
            valueAddress: undefined,
        },
        {
            name: "emergency motor stop without ARC",
            mnemonic: "EAd",
            address: 242,
            bit: 1,
            valueAddress: undefined,
        },
        {
            name: "emergency motor stop with ARC",
            mnemonic: "EOd",
            address: 242,
            bit: 2,
            valueAddress: undefined,
        },
        {
            name: "Short circuit of temperature sensor 1",
            mnemonic: "ES1",
            address: 242,
            bit: 3,
            valueAddress: undefined,
        },
        {
            name: "Breakout of temperature sensor 1",
            mnemonic: "EO1",
            address: 242,
            bit: 4,
            valueAddress: undefined,
        },
        {
            name: "Short circuit of temperature sensor 2",
            mnemonic: "ES2",
            address: 242,
            bit: 5,
            valueAddress: undefined,
        },
        {
            name: "Breakout of temperature sensor 2",
            mnemonic: "EO2",
            address: 242,
            bit: 6,
            valueAddress: undefined,
        },
        {
            name: "Phase loss",
            mnemonic: "E,U",
            address: 242,
            bit: 7,
            valueAddress: undefined,
        },
        {
            name: "EEPROM destruction",
            mnemonic: "EEP",
            address: 242,
            bit: 8,
            valueAddress: undefined,
        },
        {
            name: "0-20 mA analog input",
            mnemonic: "AA,",
            address: 242,
            bit: 9,
            valueAddress: 325,
        },
        {
            name: "0-10 V analog input",
            mnemonic: "AAU",
            address: 242,
            bit: 10,
            valueAddress: 326,
        },
    ];
    
    async function rawReadRegs(address, registersNum) {
        const deviceInfo = await getResponse(`${API_BASE_URL}/v1/device/${DEVICE_ID}/`);

        const body = {
            deviceModbusId: deviceInfo.modbusUnitId,
            address: address,
            kind: "holding",
            registersNum: registersNum,
            connection: {
                kind: "net-id",
                networkId: deviceInfo.netId,
            }
        }

        const res = await postResponse(body,`${API_BASE_URL}/v1/raw/read-register-group/`);
        return res;
    }

    async function writeRegValues(address, values) {
        const deviceInfo = await getResponse(`${API_BASE_URL}/v1/device/${DEVICE_ID}/`);

        const body = {
            deviceModbusId: deviceInfo.modbusUnitId,
            address: address,
            kind: "holding",
            value: values,
            connection: {
                kind: "net-id",
                networkId: deviceInfo.netId,
            }
        }

        const res = await postResponse(body, `${API_BASE_URL}/v1/raw/write-register-group/`);
        return res;
    }

    async function readBit(address, bitPosition) {
        if (bitPosition < 0 || bitPosition > 15) {
            console.log("can't process the bit position");
            return NaN;
        }
        const rawReg = await rawReadRegs(address, 1);
        if (rawReg.ok) {
            const regContents = rawReg.ok[0];
            const bitValue = (regContents >>> bitPosition) & 1;
            return bitValue;
        } else {
            return undefined;
        }
    }

    function barValue(barId, maxValue, threshold1, threshold2) {
        const v = document.querySelector(barId).value;
        const widthPercentage = 100 * v / maxValue;
        const innerBarId = barId + '-inner';

        let threshold1Percentage = undefined;
        let threshold2Percentage = undefined;
 
        if ((threshold2 !== undefined) && (threshold1 !== undefined)) {
            threshold1Percentage = 100 * threshold1 / maxValue;
            threshold2Percentage = 100 * threshold2 / maxValue;

            const innerOverBarId = barId  + '-over-inner';
            const innerOver2BarId = barId  + '-over2-inner';

            if (widthPercentage <= threshold1Percentage) {
                const widthPercentageStr = widthPercentage.toFixed(0) + '%';       
                document.querySelector(innerBarId).style.width = widthPercentageStr;
                document.querySelector(innerOverBarId).style.width = "0%";
                document.querySelector(innerOver2BarId).style.width = "0%";
            } else if (widthPercentage <= threshold2Percentage) {
                const widthPercentageStr = threshold1Percentage.toFixed(0) + '%';       
                document.querySelector(innerBarId).style.width = widthPercentageStr;
                const widthPercentageOverStr = (widthPercentage - threshold1Percentage).toFixed(0) + '%';
                document.querySelector(innerOverBarId).style.width = widthPercentageOverStr;
                document.querySelector(innerOver2BarId).style.width = "0%";
            } else if (widthPercentage <= 100) {
                const widthPercentageStr = threshold1Percentage.toFixed(0) + '%';       
                document.querySelector(innerBarId).style.width = widthPercentageStr;
                const widthPercentageOverStr = (threshold2Percentage - threshold1Percentage).toFixed(0) + '%';
                document.querySelector(innerOverBarId).style.width = widthPercentageOverStr;
                const widthPercentageOver2Str = (widthPercentage - threshold2Percentage).toFixed(0) + '%';
                document.querySelector(innerOver2BarId).style.width = widthPercentageOver2Str;
            }
        } else if (threshold1 !== undefined) {
            threshold1Percentage = 100 * threshold1 / maxValue;

            const innerOverBarId = barId  + '-over-inner';

            if (widthPercentage <= threshold1Percentage) {
                const widthPercentageStr = widthPercentage.toFixed(0) + '%';       
                document.querySelector(innerBarId).style.width = widthPercentageStr;
                document.querySelector(innerOverBarId).style.width = "0%";
            } else if (widthPercentage <= 100) {
                const widthPercentageStr = threshold1Percentage.toFixed(0) + '%';       
                document.querySelector(innerBarId).style.width = widthPercentageStr;
                const widthPercentageOverStr = (widthPercentage - threshold1Percentage).toFixed(0) + '%';
                document.querySelector(innerOverBarId).style.width = widthPercentageOverStr;
            }
        }
        if ((threshold1 === undefined) && (threshold2 === undefined)) {
            const widthPercentageStr = widthPercentage.toFixed(0) + '%';       
            document.querySelector(innerBarId).style.width = widthPercentageStr;
        }
    }

    function addRow(col1Text, col2Text, col3Text, col4Text) {
        let tableBody = document.getElementsByTagName("tbody").item(0);
        let row = document.createElement("tr");
       
        let cell1 = document.createElement("td");
        let cell2 = document.createElement("td");
        let cell3 = document.createElement("td");
        let cell4 = document.createElement("td");

        let textNode1 = document.createTextNode(col1Text);
        let textNode2 = document.createTextNode(col2Text);
        let textNode3 = document.createTextNode(col3Text);
        let textNode4 = document.createTextNode(col4Text);

        cell1.appendChild(textNode1);
        cell2.appendChild(textNode2);
        cell3.appendChild(textNode3);
        cell4.appendChild(textNode4);

        row.appendChild(cell1);
        row.appendChild(cell2);
        row.appendChild(cell3);
        row.appendChild(cell4);

        tableBody.appendChild(row);
    }

    function arraysEqual(arr1, arr2) {
        const len1 = arr1.length;
        const len2 = arr2.length;
        if (len1 !== len2) {
            return false;
        } else {
            for (let i=0; i < len1; i++) {
                if (arr1[i] !== arr2[i]) {
                    return false;
                }
            }
            return true;
        }
    }

    let previousFaultList = [];

    var faultsPrev = Array(alarms.length).fill(false);

    async function updateVis() {
        await processUbzStatuses();
        await processArIndicator();
        await processRcIndicator();

        const FAULT_BIT = 0;
        const FAULT = 1;

        let isFault = await readBit(240, FAULT_BIT) == FAULT;
        if (isFault) {
            processFaultIndicator(isFault);

            let faultsCurr = await determineFaults();

            let faultsToPrint = faultsSouldBePrinted(faultsPrev, faultsCurr);
            for (let i=0; i<faultsCurr.length; i++) {
                if (faultsToPrint[i]) {
                    let currentDateTime = new Date();

                    const hoursNum = currentDateTime.getHours();
                    let hoursStr = hoursNum.toString();
                    if (hoursNum < 10) {
                        hoursStr = "0" + hoursStr;
                    }

                    const minutesNum = currentDateTime.getMinutes();
                    let minutesStr = minutesNum.toString();
                    if (minutesNum < 10) {
                        minutesStr = "0" + minutesStr;
                    }

                    const secondsNum = currentDateTime.getSeconds();
                    let secondsStr = secondsNum.toString();
                    if (secondsNum < 10) {
                        secondsStr = "0" + secondsStr;
                    }

                    let time = hoursStr + ":" + minutesStr + ":" + secondsStr;

                    const fault = alarms[i];
                    if (fault.valueAddress === undefined) {
                        addRow(fault.name, fault.mnemonic, "", time);
                    } else {
                        let valueRaw = await rawReadRegs(fault.valueAddress, 1);
                        addRow(fault.name, fault.mnemonic, valueRaw.ok[0].toString(), time);
                    }
                }
            }

            faultsPrev = faultsCurr;
        }

        const phaseRmsCurrentRaw = await rawReadRegs(100, 3);
        if (phaseRmsCurrentRaw.ok) {
            document.querySelector("#phase-1-current-rms-value").innerHTML = (phaseRmsCurrentRaw.ok[0] * 0.1).toFixed(1);
            document.querySelector("#phase-2-current-rms-value").innerHTML = (phaseRmsCurrentRaw.ok[1] * 0.1).toFixed(1);
            document.querySelector("#phase-3-current-rms-value").innerHTML = (phaseRmsCurrentRaw.ok[2] * 0.1).toFixed(1);
            document.querySelector("#phase-1-current-rms-bar").value = phaseRmsCurrentRaw.ok[0];
            document.querySelector("#phase-2-current-rms-bar").value = phaseRmsCurrentRaw.ok[1];
            document.querySelector("#phase-3-current-rms-bar").value = phaseRmsCurrentRaw.ok[2];
        } else if (phaseRmsCurrentRaw.err) {
            document.querySelector("#phase-1-current-rms-value").innerHTML = "Err";
            document.querySelector("#phase-2-current-rms-value").innerHTML = "Err";
            document.querySelector("#phase-3-current-rms-value").innerHTML = "Err";
            document.querySelector("#phase-1-current-rms-bar").value = 0;
            document.querySelector("#phase-2-current-rms-bar").value = 0;
            document.querySelector("#phase-3-current-rms-bar").value = 0;
        }

        const zeroSequenceCurrentRaw = await rawReadRegs(103, 1);
        if (zeroSequenceCurrentRaw.ok) {
            document.querySelector("#zero-sequence-current-value").innerHTML = (zeroSequenceCurrentRaw.ok[0] * 0.1).toFixed(1);
            document.querySelector("#zero-sequence-current-bar").value = zeroSequenceCurrentRaw.ok[0];
        } else if (zeroSequenceCurrentRaw.err) {
            document.querySelector("#zero-sequence-current-value").innerHTML = "Err";
            document.querySelector("#zero-sequence-current-bar").value = 0;
        }
        barValue("#zero-sequence-current-bar", 50);

        const currentAverageRaw = await rawReadRegs(104, 3);
        if (currentAverageRaw.ok) {
            document.querySelector("#avg-current-value-phase-1").innerHTML = (currentAverageRaw.ok[0] * 0.1).toFixed(1);
            document.querySelector("#avg-current-value-phase-2").innerHTML = (currentAverageRaw.ok[1] * 0.1).toFixed(1);
            document.querySelector("#avg-current-value-phase-3").innerHTML = (currentAverageRaw.ok[2] * 0.1).toFixed(1);
        } else if (currentAverageRaw.err) {
            document.querySelector("#avg-current-value-phase-1").innerHTML = "Err";
            document.querySelector("#avg-current-value-phase-2").innerHTML = "Err";
            document.querySelector("#avg-current-value-phase-3").innerHTML = "Err";
        }

        const motorStartCurrentRaw = await rawReadRegs(110, 1);
        if (motorStartCurrentRaw.ok && motorStartCurrentRaw.ok[0]) {
            document.querySelector("#motor-start-current-value").innerHTML = (motorStartCurrentRaw.ok[0] * 0.1).toFixed(1);
        } else if (motorStartCurrentRaw.err) {
            document.querySelector("#motor-start-current-value").innerHTML = "Err";
        }

        const overloadCurrentRaw = await rawReadRegs(112, 1);
        if (overloadCurrentRaw.ok) {
            document.querySelector("#overload-current-value").innerHTML = (overloadCurrentRaw.ok[0] * 0.1).toFixed(1);
        } else if (overloadCurrentRaw.err) {
            document.querySelector("#overload-current-value").innerHTML = "Err";
        }

        const negativeSequenceCurrentRaw = await rawReadRegs(113, 1);
        if (negativeSequenceCurrentRaw.ok) {
            document.querySelector("#negative-sequence-current-value").innerHTML = (negativeSequenceCurrentRaw.ok[0] * 0.1).toFixed(1);
            document.querySelector("#negative-sequence-current-bar").value = negativeSequenceCurrentRaw.ok[0];
        } else if (negativeSequenceCurrentRaw.err) {
            document.querySelector("#negative-sequence-current-value").innerHTML = "Err";
            document.querySelector("#negative-sequence-current-bar").value = 0;
        }
        barValue("#negative-sequence-current-bar", 2000);

        const currentAverageForTimeRaw = await rawReadRegs(153, 1);
        if (currentAverageForTimeRaw.ok) {
            document.querySelector("#current-average-for-time-value").innerHTML = currentAverageForTimeRaw.ok[0];
        } else if (currentAverageForTimeRaw.err) {
            document.querySelector("#current-average-for-time-value").innerHTML = "Err";
        }

        const phaseRmsVoltageRaw = await rawReadRegs(114, 3);
        if (phaseRmsVoltageRaw.ok) {
            document.querySelector("#phase-1-voltage-value").innerHTML = phaseRmsVoltageRaw.ok[0];
            document.querySelector("#phase-2-voltage-value").innerHTML = phaseRmsVoltageRaw.ok[1];
            document.querySelector("#phase-3-voltage-value").innerHTML = phaseRmsVoltageRaw.ok[2];
            document.querySelector("#phase-1-voltage-bar").value = phaseRmsVoltageRaw.ok[0];
            document.querySelector("#phase-2-voltage-bar").value = phaseRmsVoltageRaw.ok[1];
            document.querySelector("#phase-3-voltage-bar").value = phaseRmsVoltageRaw.ok[2];
        } else if (phaseRmsVoltageRaw.err) {
            document.querySelector("#phase-1-voltage-value").innerHTML = "Err";
            document.querySelector("#phase-2-voltage-value").innerHTML = "Err";
            document.querySelector("#phase-3-voltage-value").innerHTML = "Err";
            document.querySelector("#phase-1-voltage-bar").value = 0;
            document.querySelector("#phase-2-voltage-bar").value = 0;
            document.querySelector("#phase-3-voltage-bar").value = 0;
        }
        barValue("#phase-1-voltage-bar", 300, PHASE_VOLTAGE_THRESHOLD);
        barValue("#phase-2-voltage-bar", 300, PHASE_VOLTAGE_THRESHOLD);
        barValue("#phase-3-voltage-bar", 300, PHASE_VOLTAGE_THRESHOLD);

        const lineVoltageRaw = await rawReadRegs(117, 3);
        if (lineVoltageRaw.ok) {
            document.querySelector("#line-1-voltage-value").innerHTML = lineVoltageRaw.ok[0];
            document.querySelector("#line-2-voltage-value").innerHTML = lineVoltageRaw.ok[1];
            document.querySelector("#line-3-voltage-value").innerHTML = lineVoltageRaw.ok[2];
            document.querySelector("#line-1-voltage-bar").value = lineVoltageRaw.ok[0];
            document.querySelector("#line-2-voltage-bar").value = lineVoltageRaw.ok[1];
            document.querySelector("#line-3-voltage-bar").value = lineVoltageRaw.ok[2];
        } else if (lineVoltageRaw.err) {
            document.querySelector("#line-1-voltage-value").innerHTML = "Err";
            document.querySelector("#line-2-voltage-value").innerHTML = "Err";
            document.querySelector("#line-3-voltage-value").innerHTML = "Err";
            document.querySelector("#line-1-voltage-bar").value = 0;
            document.querySelector("#line-2-voltage-bar").value = 0;
            document.querySelector("#line-3-voltage-bar").value = 0;
        }

        const lineVoltageMinRaw = await rawReadRegs(177, 1);
        const lineVoltageMaxRaw = await rawReadRegs(180, 1);
        if (lineVoltageMinRaw.ok && lineVoltageMaxRaw.ok) {
            barValue("#line-1-voltage-bar", 475, lineVoltageMinRaw.ok[0], lineVoltageMaxRaw.ok[0]);
            barValue("#line-2-voltage-bar", 475, lineVoltageMinRaw.ok[0], lineVoltageMaxRaw.ok[0]);
            barValue("#line-3-voltage-bar", 475, lineVoltageMinRaw.ok[0], lineVoltageMaxRaw.ok[0]);
        }

        const positiveSequenceVoltageRaw = await rawReadRegs(120, 1);
        if (positiveSequenceVoltageRaw.ok) {
            document.querySelector("#positive-sequence-voltage-value").innerHTML = positiveSequenceVoltageRaw.ok[0];
        } else if (positiveSequenceVoltageRaw.err) {
            document.querySelector("#positive-sequence-voltage-value").innerHTML = "Err";
        }

        const negativeSequenceVoltageRaw = await rawReadRegs(121, 1);
        if (negativeSequenceVoltageRaw.ok) {
            document.querySelector("#negative-sequence-voltage-value").innerHTML = negativeSequenceVoltageRaw.ok[0];
            document.querySelector("#negative-sequence-voltage-bar").value = negativeSequenceVoltageRaw.ok[0];
        } else if (negativeSequenceVoltageRaw.err) {
            document.querySelector("#negative-sequence-voltage-value").innerHTML = "Err";
            document.querySelector("#negative-sequence-voltage-bar").value = 0;
        }
        barValue("#negative-sequence-voltage-bar", 300);

        const zeroSequenceVoltageRaw = await rawReadRegs(122, 1);
        if (zeroSequenceVoltageRaw.ok) {
            document.querySelector("#zero-sequence-voltage-value").innerHTML = zeroSequenceVoltageRaw.ok[0];
        } else if (zeroSequenceVoltageRaw.err) {
            document.querySelector("#zero-sequence-voltage-value").innerHTML = "Err";
        }

        const sensorTemperatureRaw = await rawReadRegs(123, 2);
        if (sensorTemperatureRaw.ok) {
            document.querySelector("#sensor-1-temperature-value").innerHTML = temperatureSensorReadable(sensorTemperatureRaw.ok[0]);
            document.querySelector("#sensor-2-temperature-value").innerHTML = temperatureSensorReadable(sensorTemperatureRaw.ok[1]);
        } else if (sensorTemperatureRaw.err) {
            document.querySelector("#sensor-1-temperature-value").innerHTML = "Err";
            document.querySelector("#sensor-2-temperature-value").innerHTML = "Err";
        }

        const frequencyRaw = await rawReadRegs(128, 1);
        if (frequencyRaw.ok) {
            document.querySelector("#frequency-value").innerHTML = (frequencyRaw.ok[0] * 0.1).toFixed(1);
        } else if (frequencyRaw.err) {
            document.querySelector("#frequency-value").innerHTML = "Err";
        }

        const insulationResistanceRaw = await rawReadRegs(132, 1);
        if (insulationResistanceRaw.ok) {
            document.querySelector("#insulation-resistance-value").innerHTML = (insulationResistanceRaw.ok[0] * 0.1).toFixed(1);
        } else if (insulationResistanceRaw.err) {
            document.querySelector("#insulation-resistance-value").innerHTML = "Err";
        }

        const currentInputRaw = await rawReadRegs(125, 1);
        if (currentInputRaw.ok) {
            document.querySelector("#current-input-value").innerHTML = (currentInputRaw.ok[0] * 0.01).toFixed(2);
        } else if (currentInputRaw.err) {
            document.querySelector("#current-input-value").innerHTML = "Err";
        }

        const analogInputRaw = await rawReadRegs(126, 1);
        if (analogInputRaw.ok) {
            document.querySelector("#analog-input-value").innerHTML = (analogInputRaw.ok[0] * 0.1).toFixed(1);
        } else if (analogInputRaw.err) {
            document.querySelector("#analog-input-value").innerHTML = "Err";
        }

        const timeBeforeArRaw = await rawReadRegs(130, 1);
        if (timeBeforeArRaw.ok) {
            if (timeBeforeArRaw.ok[0] == 0) {
                document.querySelector("#time-before-ar-string").innerHTML = "Off";
                document.querySelector("#time-before-ar-bar").value = 0;
            } else if (timeBeforeArRaw.ok[0] > 0 && timeBeforeArRaw.ok[0] <= 900) {
                document.querySelector("#time-before-ar-string").innerHTML = timeBeforeArRaw.ok[0].toString();
                document.querySelector("#time-before-ar-bar").value = timeBeforeArRaw.ok[0];
            } else if (timeBeforeArRaw.ok[0] == 950) {
                document.querySelector("#time-before-ar-string").innerHTML = "No AR";
                document.querySelector("#time-before-ar-bar").value = 0;
            } else {
                document.querySelector("#time-before-ar-string").innerHTML = "???";
                document.querySelector("#time-before-ar-bar").value = 0;
            }
        } else if (timeBeforeArRaw.err) {
            document.querySelector("#time-before-ar-string").innerHTML = "Err";
            document.querySelector("#time-before-ar-bar").value = 0;
        }
        barValue("#negative-sequence-voltage-bar", 900);

        const relayWorkModeRaw = await rawReadRegs(205, 1);
        if (relayWorkModeRaw.ok) {
            if (relayWorkModeRaw.ok[0] == 0) {
                document.querySelector("#radio-workmode-alarm").checked = true;
            } else if (relayWorkModeRaw.ok[0] == 1) {
                document.querySelector("#radio-workmode-time").checked = true;
            } else if (relayWorkModeRaw.ok[0] == 2) {
                document.querySelector("#radio-workmode-stardelta").checked = true;
            }
        }

        const startupTimeRaw = await rawReadRegs(111, 1); // 111??
        if (startupTimeRaw.ok) {
            document.querySelector("#startup-time-value").innerHTML = startupTimeRaw.ok[0];
        } else if (startupTimeRaw.err) {
            document.querySelector("#startup-time-value").innerHTML = "Err";
        }

        const transferRateRaw = await rawReadRegs(213, 1);
        if (transferRateRaw.ok) {
            switch (transferRateRaw.ok[0]) {
                case 0: {
                    document.querySelector("#speed-value").innerHTML = "9600";
                }
                break;
                case 1: {
                    document.querySelector("#speed-value").innerHTML = "19200";
                }
                break;
                default: {
                    document.querySelector("#speed-value").innerHTML = "Incorrect register value";
                }
                break;
            }
        } else if (transferRateRaw.err) {
            document.querySelector("#speed-value").innerHTML = "Err";
        }

        const ubzCommunicationAddressRaw = await rawReadRegs(212, 1);
        if (ubzCommunicationAddressRaw.ok) {
            deviceConnected = true;
            document.querySelector("#modbus-address-ubz").value = ubzCommunicationAddressRaw.ok[0];
        } else if (ubzCommunicationAddressRaw.err == "Can't acquire connection") {
            deviceConnected = false;
        }

        if (deviceConnected) {
            document.querySelector("#connection-status-string").innerHTML = "Connected";
        } else {
            document.querySelector("#connection-status-string").innerHTML = "Disonnected";
        }
    }

    async function initElements() {
        {
            const outstring = await showPowerCharacteristicByKey(document.querySelector("#power-characteristic-value-1").value);
            document.querySelector("#power-show-value-1").innerHTML = outstring;
        }
        {
            const outstring = await showPowerCharacteristicByKey(document.querySelector("#power-characteristic-value-2").value);
            document.querySelector("#power-show-value-2").innerHTML = outstring;
        }
        {
            const outstring = await showPowerCharacteristicByKey(document.querySelector("#power-characteristic-value-3").value);
            document.querySelector("#power-show-value-3").innerHTML = outstring;
        }
    }

    async function processUbzStatuses() {
        const mmspModeRaw = await rawReadRegs(202, 1);

        const LOAD_RELAY_BIT = 1;
        const FUNCTIONAL_RELAY_BIT = 2;
        const CLOSED = 1;

        const LED_LIT = "lightgreen";
        const LED_DIM = "darkgreen";

        if (mmspModeRaw.ok) {
            if (mmspModeRaw.ok[0] == 1) {
                document.querySelector("#mmsp-mode").style.backgroundColor = LED_LIT;
            }
        }
        else {
            document.querySelector("#mmsp-mode").style.backgroundColor = LED_DIM;
        }

        if (await readBit(240, FUNCTIONAL_RELAY_BIT) == CLOSED) {
            document.querySelector("#functional-relay-mode").style.backgroundColor = LED_LIT;
        } else {
            document.querySelector("#functional-relay-mode").style.backgroundColor = LED_DIM;
        }

        if (await readBit(240, LOAD_RELAY_BIT) == CLOSED) {
            document.querySelector("#motor-relay-mode").style.backgroundColor = LED_LIT;
        } else {
            document.querySelector("#motor-relay-mode").style.backgroundColor = LED_DIM;
        }
    }

    async function determineFaults() {
        const FAULT = 1;
        const faultsOccurNow = [];
        // set of alarms bit located in these two registers:
        let alarmsBitsRaw = await rawReadRegs(alarms[0].address, 2);
        if(alarmsBitsRaw.ok) {
            for (let i=0; i<16; i++) {
                faultsOccurNow.push(((alarmsBitsRaw.ok[0] >>> i) & 1) === FAULT);
            }
            for (let i=16; i<alarms.length; i++) {
                faultsOccurNow.push(((alarmsBitsRaw.ok[1] >>> (i-16)) & 1) === FAULT);
            }
        }

        return faultsOccurNow;
    }

    function faultsSouldBePrinted(faultsPrev, faultsCurr) /* boolean arrays */ {
        if (faultsPrev.length != faultsCurr.length) {
            console.log("arrays lengths must be equal!");
            return undefined;
        }

        const shouldBePrinted = Array(faultsCurr.length).fill(false);

        for (let i=0; i<faultsCurr.length; i++) {
            if ((!faultsPrev[i]) && (faultsCurr[i])) {
                shouldBePrinted[i] = true;
            }
        }

        return shouldBePrinted;
    }

    function processFaultIndicator(isFault) {
        const LED_SWITCH_INTERVAL_MS = 1000;
        if (isFault) {
            if (!faultIndicatorSet) {
                let lighten = false;

                var faultIndicatorInterval = setInterval(function() {
                    if (lighten) {
                        document.querySelector("#fault-indicator").style.backgroundColor = "lightsalmon";
                    } else {
                        document.querySelector("#fault-indicator").style.backgroundColor = "crimson";
                    }
                    lighten = !lighten;
                }, LED_SWITCH_INTERVAL_MS);

                faultIndicatorSet = true;
            }
        } else {
            if (faultIndicatorSet) {
                faultIndicatorSet = false;
                clearInterval(faultIndicatorInterval);
            }
        }
    }

    var motorStartedManually = false;

    async function startStopMotor() {
        const COMMAND_REGISTER = 237;
        const MOTOR_STOP_MANUALLY = [0];
        const MOTOR_START_MANUALLY = [2];

        if (!motorStartedManually) {
            writeRegValues(COMMAND_REGISTER, MOTOR_START_MANUALLY);
            document.querySelector("#motor-start-stop-button").innerHTML = "Stop";
            motorStartedManually = true;
        } else {
            writeRegValues(COMMAND_REGISTER, MOTOR_STOP_MANUALLY);
            document.querySelector("#motor-start-stop-button").innerHTML = "Start";
            motorStartedManually = false;
        }
    }

    async function processArIndicator() {
        const INDICATOR_LIT = "lightgreen";
        const INDICATOR_DIM = "green";
        const ALLOW_REMOTE = 2;

        const arStatusRaw = await rawReadRegs(203, 1);
        if (arStatusRaw.ok && arStatusRaw.ok[0] == ALLOW_REMOTE) {
            document.querySelector("#ar-indicator").style.backgroundColor = INDICATOR_LIT;
        } else {
            document.querySelector("#ar-indicator").style.backgroundColor = INDICATOR_DIM;
        }
    }

    async function processRcIndicator() {
        const INDICATOR_LIT = "lightcyan";
        const INDICATOR_DIM = "dodgerblue";
        const PROHIBITED = 0;

        const remoteRaw = await rawReadRegs(221, 1);
        if (remoteRaw.ok && remoteRaw.ok[0] != PROHIBITED) {
            document.querySelector("#rc-indicator").style.backgroundColor = INDICATOR_LIT;
            document.querySelector("#motor-start-stop-button").innerHTML = "Start";
            document.querySelector("#motor-start-stop-button").disabled = false;
            document.querySelector("#motor-start-stop-button").addEventListener("click", startStopMotor);
        } else {
            document.querySelector("#rc-indicator").style.backgroundColor = INDICATOR_DIM;
            document.querySelector("#motor-start-stop-button").innerHTML = "<img src = 'https://cdn-icons-png.flaticon.com/512/2479/2479510.png' style='width: 100px;'>";
            document.querySelector("#motor-start-stop-button").disabled = true;
            document.querySelector("#motor-start-stop-button").removeEventListener("click", startStopMotor);
        }
    }

    const Y100 = canvas.height * 0.1;
    const Y66 = canvas.height * 0.3;

    function drawGraph() {
        ctx.beginPath();

        ctx.strokeStyle = "crimson";
        ctx.lineWidth = 1;
        ctx.moveTo(0, Y100);
        ctx.lineTo(canvas.width, Y100);
        ctx.stroke();
        ctx.strokeText("100%", Y100, Y100);

        ctx.beginPath();
        ctx.strokeStyle = "dodgerblue";
        ctx.moveTo(0, Y66);
        ctx.lineTo(canvas.width, Y66);
        ctx.stroke();
        ctx.strokeText("66%", Y100, Y66);
    }

    initElements();
    updateVis();
    drawGraph();

    setInterval(updateVis, UPDATE_VISUALIZATION_INTERVAL_MS);

    // TODO: affect only when changed
    document.querySelector("#radio-workmode-alarm").addEventListener("click", async function() {
        await writeRegValues(205, [0]);
    })

    document.querySelector("#radio-workmode-time").addEventListener("click", async function () {
        await writeRegValues(205, [1]);
    })

    document.querySelector("#radio-workmode-stardelta").addEventListener("click", async function () {
        await writeRegValues(205, [2]);
    })

    function sinFromCos(cosValue) {
        return Math.sqrt(1 - Math.pow(cosValue, 2));
    }

    async function showPowerCharacteristicByKey(keystring) {
        var outstring = "Unknown";
        switch (keystring) {
            case "full-power":
                {
                    const fullPowerRaw = await rawReadRegs(135, 1);
                    if (fullPowerRaw.ok) {
                        const fullPower = fullPowerRaw.ok[0] * 0.01;
                        outstring = fullPower.toString();
                    }
                }
                break;
            case "active-power":
                {
                    const activePowerRaw = await rawReadRegs(137, 1);
                    if (activePowerRaw.ok) {
                        const activePower = activePowerRaw.ok[0] * 0.01;
                        outstring = activePower.toString();
                    }
                }
                break;
            case "reactive-power":
                {
                    const reactivePowerRaw = await rawReadRegs(139, 1);
                    if (reactivePowerRaw.ok) {
                        const reactivePower = reactivePowerRaw.ok[0] * 0.01;
                        outstring = reactivePower.toString();
                    }
                }
                break;
            case "phase-1-full-power":
                {
                    const RMSVoltagePhase1Raw = await rawReadRegs(114, 1);
                    const RMSCurrentPhase1Raw = await rawReadRegs(100, 1);
                    if (RMSVoltagePhase1Raw.ok && RMSCurrentPhase1Raw.ok) {
                        const RMSVoltagePhase1 = RMSVoltagePhase1Raw.ok[0];
                        const RMSCurrentPhase1 = RMSCurrentPhase1Raw.ok[0] * 0.1;
                        const phase1FullPower = RMSVoltagePhase1 * RMSCurrentPhase1;
                        outstring = phase1FullPower.toString();
                    }
                }
                break;
            case "phase-2-full-power":
                {
                    const RMSVoltagePhase2Raw = await rawReadRegs(115, 1);
                    const RMSCurrentPhase2Raw = await rawReadRegs(101, 1);
                    if (RMSVoltagePhase2Raw.ok && RMSCurrentPhase2Raw.ok) {
                        const RMSVoltagePhase2 = RMSVoltagePhase2Raw.ok[0];
                        const RMSCurrentPhase2 = RMSCurrentPhase2Raw.ok[0] * 0.1;
                        const phase2FullPower = RMSVoltagePhase2 * RMSCurrentPhase2;
                        outstring = phase2FullPower.toString();
                    }
                }
                break;
            case "phase-3-full-power":
                {
                    const RMSVoltagePhase3Raw = await rawReadRegs(116, 1);
                    const RMSCurrentPhase3Raw = await rawReadRegs(102, 1);
                    if (RMSVoltagePhase3Raw.ok && RMSCurrentPhase3Raw.ok) {
                        const RMSVoltagePhase3 = RMSVoltagePhase3Raw.ok[0];
                        const RMSCurrentPhase3 = RMSCurrentPhase3Raw.ok[0] * 0.1;
                        const phase3FullPower = RMSVoltagePhase3 * RMSCurrentPhase3;
                        outstring = phase3FullPower.toString();
                    }
                }
                break;
            case "phase-1-active-power":
                {
                    const RMSVoltagePhase1Raw = await rawReadRegs(114, 1);
                    const RMSCurrentPhase1Raw = await rawReadRegs(100, 1);
                    const cosPhiPhase1Raw = await rawReadRegs(141, 1);
                    if (RMSVoltagePhase1Raw.ok && RMSCurrentPhase1Raw.ok && cosPhiPhase1Raw.ok) {
                        const RMSVoltagePhase1 = RMSVoltagePhase1Raw.ok[0];
                        const RMSCurrentPhase1 = RMSCurrentPhase1Raw.ok[0] * 0.1;
                        const cosPhiPhase1 = cosPhiPhase1Raw.ok[0] * 0.001;
                        const phase1activePower = RMSVoltagePhase1 * RMSCurrentPhase1 * cosPhiPhase1;
                        outstring = phase1activePower.toString();
                    }
                }
                break;
            case "phase-2-active-power":
                {
                    const RMSVoltagePhase2Raw = await rawReadRegs(115, 1);
                    const RMSCurrentPhase2Raw = await rawReadRegs(101, 1);
                    const cosPhiPhase2Raw = await rawReadRegs(143, 1);
                    if (RMSVoltagePhase2Raw.ok && RMSCurrentPhase2Raw.ok && cosPhiPhase2Raw.ok) {
                        const RMSVoltagePhase2 = RMSVoltagePhase2Raw.ok[0];
                        const RMSCurrentPhase2 = RMSCurrentPhase2Raw.ok[0] * 0.1;
                        const cosPhiPhase2 = cosPhiPhase2Raw.ok[0] * 0.001;
                        const phase2activePower = RMSVoltagePhase2 * RMSCurrentPhase2 * cosPhiPhase2;
                        outstring = phase2activePower.toString();
                    }
                }
                break;
            case "phase-3-active-power":
               {
                    const RMSVoltagePhase3Raw = await rawReadRegs(116, 1);
                    const RMSCurrentPhase3Raw = await rawReadRegs(102, 1);
                    const cosPhiPhase3Raw = await rawReadRegs(145, 1);
                    if (RMSVoltagePhase3Raw.ok && RMSCurrentPhase3Raw.ok && cosPhiPhase3Raw.ok) {
                        const RMSVoltagePhase3 = RMSVoltagePhase3Raw.ok[0];
                        const RMSCurrentPhase3 = RMSCurrentPhase3Raw.ok[0] * 0.1;
                        const cosPhiPhase3 = cosPhiPhase3Raw.ok[0] * 0.001;
                        const phase3activePower = RMSVoltagePhase3 * RMSCurrentPhase3 * cosPhiPhase3;
                        outstring = phase3activePower.toString();
                    }
                }
                break;
            case "phase-1-reactive-power":
                {
                    const RMSVoltagePhase1Raw = await rawReadRegs(114, 1);
                    const RMSCurrentPhase1Raw = await rawReadRegs(100, 1);
                    const cosPhiPhase1Raw = await rawReadRegs(141, 1);
                    if (RMSVoltagePhase1Raw.ok && RMSCurrentPhase1Raw.ok && cosPhiPhase1Raw.ok) {
                        const RMSVoltagePhase1 = RMSVoltagePhase1Raw.ok[0];
                        const RMSCurrentPhase1 = RMSCurrentPhase1Raw.ok[0] * 0.1;
                        const cosPhiPhase1 = cosPhiPhase1Raw.ok[0] * 0.001;
                        const sinPhiPhase1 = sinFromCos(cosPhiPhase1);
                        const phase1reactivePower = RMSVoltagePhase1 * RMSCurrentPhase1 * sinPhiPhase1;
                        outstring = phase1reactivePower.toString();
                    }
                }
                break;
            case "phase-2-reactive-power":
                {
                    const RMSVoltagePhase2Raw = await rawReadRegs(115, 1);
                    const RMSCurrentPhase2Raw = await rawReadRegs(101, 1);
                    const cosPhiPhase2Raw = await rawReadRegs(143, 1);
                    if (RMSVoltagePhase2Raw.ok && RMSCurrentPhase2Raw.ok && cosPhiPhase2Raw.ok) {
                        const RMSVoltagePhase2 = RMSVoltagePhase2Raw.ok[0];
                        const RMSCurrentPhase2 = RMSCurrentPhase2Raw.ok[0] * 0.1;
                        const cosPhiPhase2 = cosPhiPhase2Raw.ok[0] * 0.001;
                        const sinPhiPhase2 = sinFromCos(cosPhiPhase2);
                        const phase2reactivePower = RMSVoltagePhase2 * RMSCurrentPhase2 * sinPhiPhase2;
                        outstring = phase2reactivePower.toString();
                    }
                }
                break;
            case "phase-3-reactive-power":
                {
                    const RMSVoltagePhase3Raw = await rawReadRegs(116, 1);
                    const RMSCurrentPhase3Raw = await regV3lues(102, 1);
                    const cosPhiPhase3Raw = await regValue3(145, 1);
                    if (RMSVoltagePhase3Raw.ok && RMSCurrentPhase3Raw.ok && cosPhiPhase3Raw.ok) {
                        const RMSVoltagePhase3 = RMSVoltagePhase3Raw.ok[0];
                        const RMSCurrentPhase3 = RMSCurrentPhase3Raw.ok[0] * 0.1;
                        const cosPhiPhase3 = cosPhiPhase3Raw.ok[0] * 0.001;
                        const sinPhiPhase3 = sinFromCos(cosPhiPhase3);
                        const phase3reactivePower = RMSVoltagePhase3 * RMSCurrentPhase3 * sinPhiPhase3;
                        outstring = phase3reactivePower.toString();
                    }
                }
                break;
            case "phase-1-cos-phi":
                {
                    const cosPhiPhase1Raw = await rawReadRegs(141, 1);
                    if (cosPhiPhase1Raw.ok) {
                        const cosPhiPhase1 = cosPhiPhase1Raw.ok[0] * 0.001;
                        outstring = cosPhiPhase1.toFixed(3);
                    }
                }
                break;
            case "phase-2-cos-phi":
                {
                    const cosPhiPhase2Raw = await rawReadRegs(143, 1);
                    if (cosPhiPhase2Raw.ok) {
                        const cosPhiPhase2 = cosPhiPhase2Raw.ok[0] * 0.001;
                        outstring = cosPhiPhase2.toFixed(3);
                    }
                }
                break;
            case "phase-3-cos-phi":
                {
                    const cosPhiPhase3Raw = await rawReadRegs(145, 1);
                    if (cosPhiPhase3Raw.ok) {
                        const cosPhiPhase3 = cosPhiPhase3Raw.ok[0] * 0.001;
                        outstring = cosPhiPhase3.toFixed(3);
                    }
                }
                break;
        }
        return outstring;
    }

    document.querySelector("#power-characteristic-value-1").addEventListener("change", async function () {
        const outstring = await showPowerCharacteristicByKey(document.querySelector("#power-characteristic-value-1").value);
        document.querySelector("#power-show-value-1").innerHTML = outstring;
    })

    document.querySelector("#power-characteristic-value-2").addEventListener("change", async function () {
        const outstring = await showPowerCharacteristicByKey(document.querySelector("#power-characteristic-value-2").value);
        document.querySelector("#power-show-value-2").innerHTML = outstring;
    })

    document.querySelector("#power-characteristic-value-3").addEventListener("change", async function () {
        const outstring = await showPowerCharacteristicByKey(document.querySelector("#power-characteristic-value-3").value);
        document.querySelector("#power-show-value-3").innerHTML = outstring;
    })

    document.querySelector("#modbus-address-ubz").addEventListener("change", async function() {
        const addr = document.querySelector("#modbus-address-ubz").value;
        console.log(await writeRegValues(212, [addr]));
    })

    document.querySelector("#save-file-button").addEventListener("click", function () {
        console.log("aaa");
        const url = URL.createObjectURL(new Blob(['a', 's', 'd', 'd', 'f', 'g']));
        const hiddenEl = document.createElement("a");
        hiddenEl.href = url;
        hiddenEl.target = "_blank";
        hiddenEl.download = "Overvis";// - ${this.reportName} (${this.fromDateNaiveStr} - ${this.tillDateNaiveStr}).${format};
        hiddenEl.click();
    })

    function temperatureSensorReadable(value) {
        if (value == 5000) {
            return "Off";
        } else if (value <= 2010 && value >= 1990) {
            return "Fault";
        } else if (value <= 1010 && value >= 990) {
            return "S/C"
        } else if (value <= 220 && value >= -40) {
            return String(value);
        } else {
            return "Und.";
        }
    }
    
    async function postResponse(body, url) {
        const res = await new Promise((resolve, reject) => {
            const request = new XMLHttpRequest();
            request.onload = function() {
                const data = JSON.parse(request.response);
                resolve(data);
            }

            request.onerror = function(err) {
                console.error(err);
                reject(err)
            }

            request.open("POST", url);
            request.setRequestHeader("authorization", `token ${API_TOKEN}`);
            request.setRequestHeader("Content-Type", "application/json");
            request.send(JSON.stringify(body));
        });

        return res;
    }

    async function getResponse(url) {
        const res = await new Promise((resolve, reject) => {
            const request = new XMLHttpRequest();
            request.onload = function() {
                const data = JSON.parse(request.response);
                resolve(data);
            }

            request.onerror = function(err) {
                console.error(err);
                reject(err)
            }

            request.open("GET", url);
            request.setRequestHeader("authorization", `token ${API_TOKEN}`);
            request.setRequestHeader("Content-Type", "application/json");
            request.send();
        });

        return res;
    }
</script>
