<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
    integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">

<style type="text/css">
    .dashboard-container {
        text-align: left;
        background-color: whitesmoke;
    }

    .dashboard-header {
        margin-top: 1em;
        font-weight: bold;
        text-align: center;
    }

    .dashboard-group {
        margin-top: 8px;
        margin-bottom: 8px;
    }

    .power-characteristic {
        margin: 5px;
    }

    .status-indicator {
        display: inline-block;
        height: 1em;
        width: 1em;
        border-radius: 50%;
        margin-left: 0.25em;
        margin-right: 0.25em;
    }

    .valuebar {
        min-width: 100px;
        height: 8px;
        background-color: #9a9a9a;
    }

    .valuebar-inner {
        height: 100%;
        width: 0%;
        float: left;
    }

    .overvaluebar-inner {
        height: 100%;
        width: 0%;
        float: left;
    }

    .overvaluebar2-inner {
        height: 100%;
        width: 0%;
        float: left;
    }

    .ubz-number-input {
        width: 4em;
    }

    .substrat {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        z-index: 50;
        background-color: #f0f0f0f0;
        display: none;
    }

    .popup-menu {
        position: absolute;
        left: 25%;
        top: 25%;
        min-width: 600px;
        z-index: 100;
        background-color: white;
        display: none;
        text-align: left;
    }

    .popup-header-background {
        background-color: whitesmoke;
        padding-top: 5px;
        padding-bottom: 10px;
    }

    .popup-footer-background {
        background-color: whitesmoke;
        padding-top: 10px;
        padding-bottom: 5px;
    }

    .close-button {
        position: absolute;
        right: 20px;
        top: 10px;
    }

    .dashboard-spinner-overlay {
        position: absolute;
        left: 50%;
        top: 50%;
        z-index: 60;
    }

    .spinner-invisible {
        display: none;
    }

    #popup-menu-items {
        overflow: auto;
        max-height: 400px;
    }

    .ubz-parameter {
        margin: 10px;
    }

    .ubz-params-input {
        float: right;
        width: 8em;
    }

    #heating-graph {
        border: 1px solid lightslategrey;
        background-color: white;
        width: 240px;
    }

    .btn-vis {
        background-color: #1e8bc3;
        color: white;
    }

    .btn-pulse {
        animation: pulse-anim 1s infinite alternate ease-in-out;
    }

    @keyframes pulse-anim {
        100% {
            filter: brightness(150%);
        }
    }

    .faults-table {
        width: 100%;
    }

    .faults-table tbody {
        background-color: transparent;
        height: 27em;
        overflow: auto;
    }

    .faults-table thead>tr,
    tbody {
        width: 100%;
        display: block;
        height: 1.5em;
    }

    .faults-table th {
        text-align: center;
        padding: 4px;
        border: 3px solid transparent;
        background-color: whitesmoke;
        font-size: smaller;
    }

    #dashboard-table-currents tbody {
        height: 6em;
    }

    @media only screen and (max-device-width: 1100px) {
        .power-characteristic {
            padding: 10px;
        }

        .popup-menu {
            position: absolute;
            left: 0%;
            top: 25%;
            z-index: 100;
            background-color: white;
            display: none;
            text-align: left;
        }
    }
</style>

<div id="ubz-vis-container">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- put actual device="#DEVICE_ID" number from database instead of 0 here -->
    <alias device="#0" name="ubz"></alias>
    <h2>UBZ-302 Control Panel</h2>
    <div style="text-align: left;" id="session-time">Session time: </div>

    <div class="container dashboard-container">
        <div class="row">
            <div class="col-sm">
                <header class="dashboard-header">UBZ Status</header>
                <div class="dashboard-group">
                    <div><span class="status-indicator bg-success" id="mmsp-mode"></span>MMSP</div>
                    <div><span class="status-indicator bg-success" id="functional-relay-mode"></span>Functional relay
                    </div>
                    <div><span class="status-indicator bg-success" id="motor-relay-mode"></span>Motor relay</div>
                </div>
                <div class="dashboard-group">
                    <header class="dashboard-header">Functional relay work mode</header>

                    <form id="functional-relay-work-mode-radio">
                        <input type="radio" id="radio-workmode-alarm" name="func-relay-workmode" value="alarmrelay">
                        <label for="radio-workmode-alarm">Alarm relay</label><br>
                        <input type="radio" id="radio-workmode-time" name="func-relay-workmode" value="timerelay">
                        <label for="radio-workmode-time">Time relay</label><br>
                        <input type="radio" id="radio-workmode-stardelta" name="func-relay-workmode" value="stardelta">
                        <label for="radio-workmode-stardelta">Star / delta</label><br>
                    </form>
                    <div class="ubz-parameter">CT in use
                        <span>
                            <select class="ubz-params-input" id="CT-in-use">
                                <option value="integrated-CT">Integrated CT</option>
                                <option value="external-CT">External CT</option>
                            </select>
                        </span>
                    </div>
                    <div class="ubz-parameter">For external CT
                        <span>
                            <input type="number" value="100" min="20" max="800" id="external-ct-current"
                                class="ubz-params-input">
                        </span>
                    </div>
                    <div class="ubz-parameter">Motor rated current
                        <span>
                            <input type="number" value="0" min="0" max="630" id="motor-rated-current"
                                class="ubz-params-input">
                        </span>
                    </div>
                </div>

                <div class="dashboard-group">
                    <details>
                        <summary>Additional</summary>
                        <ul>
                            <li>Sensor 1 temperature: <span id="sensor-1-temperature-value">Off</span></li>
                            <li>Sensor 2 temperature: <span id="sensor-2-temperature-value">Off</span></li>
                            <li>Current input: <span id="current-input-value">0.0</span> mA</li>
                            <li>Analog input: <span id="analog-input-value">0.0</span> V</li>
                            <li>Frequency: <span id="frequency-value">50.0</span> Hz</li>
                            <li>Insulation resistance: <span id="insulation-resistance-value">20.0</span> MOhm</li>
                        </ul>
                    </details>
                </div>

                <div class="dashboard-group"><button type="button" class="btn btn-vis" id="motor-start-stop-button"
                        disabled>Automatic mode</button></div>
                <div class="dashboard-group">
                    <button type="button" class="btn btn-vis" id="save-file-button">
                        <span class="spinner-border spinner-border-sm spinner-invisible" role="status"
                            aria-hidden="true" id="save-file-button-spinner"></span>
                        Log event UBZ
                    </button>
                    <button type="button" class="btn btn-vis" id="ubz-parameters-button">UBZ Parameters</button>
                </div>
            </div>
            <div class="col-sm">
                <header class="dashboard-header">UBZ Fault Status</header>

                <div class="dashboard-group">
                    <button type="button" class="btn btn-danger" id="fault-indicator" disabled>Fault</button>
                    <button type="button" class="btn btn-warning" id="ext-in-indicator" disabled>Ext. in.</button>
                    <button type="button" class="btn btn-success" id="ar-indicator" disabled>AR</button>
                    <button type="button" class="btn btn-info" id="rc-indicator" disabled>RC</button>
                    <button type="button" class="btn btn-vis" id="reset-fault-button">
                        <span class="spinner-border spinner-border-sm spinner-invisible" role="status"
                            aria-hidden="true" id="reset-fault-button-spinner"></span>
                        Reset Fault
                    </button>

                </div>
                <div class="dashboard-group">
                    <table class="faults-table">
                        <tr>
                            <th>
                                Name
                            </th>
                            <th>
                                ###
                            </th>
                            <th>
                                Value
                            </th>
                            <th>
                                Time
                            </th>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="col-sm">
                <header class="dashboard-header">Graphs</header>
                <div class="dashboard-group">
                    <div id="div-heating-graph" style="display: none;">
                        <canvas id="heating-graph">Your browser does not support the canvas element.</canvas>
                    </div>
                </div>

                <div class="dashboard-group">
                    <div class="form-check">
                        <input type="checkbox" id="minutes-voltage-graph" checked>
                        <label class="form-check-label" for="minutes-voltage-graph">
                            Minutes voltages graph scale
                        </label>
                    </div>

                    <div id="div-voltage-phases-graph" style="display: none;">
                        <canvas id="voltage-phases-graph">Your browser does not support the canvas element.</canvas>
                    </div>
                    <div id="div-voltage-phases-graph-m">
                        <canvas id="voltage-phases-graph-m">Your browser does not support the canvas element.</canvas>
                    </div>
                </div>

                <div class="dashboard-group">
                    <div class="form-check">
                        <input type="checkbox" id="minutes-amperage-graph" checked>
                        <label class="form-check-label" for="minutes-amperage-graph">
                            Minutes currents graph scale
                        </label>
                    </div>

                    <div id="div-amperage-phases-graph" style="display: none;">
                        <canvas id="amperage-phases-graph">Your browser does not support the canvas element.</canvas>
                    </div>
                    <div id="div-amperage-phases-graph-m">
                        <canvas id="amperage-phases-graph-m">Your browser does not support the canvas element.</canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm">
                <header class="dashboard-header">Current (Ampere)</header>
                <div class="dashboard-group">
                    <p>Phase currents active values:</p>
                    <ul>
                        <li>Phase1: <div class="valuebar" id="phase-1-current-rms-bar" value="0">
                                <div class="valuebar-inner bg-success" id="phase-1-current-rms-bar-inner"></div>
                            </div> <span class="spinner-border spinner-border-sm reading-process-spinner" role="status"></span> <span id="phase-1-current-rms-value">0.0</span> A</li>
                        <li>Phase2: <div class="valuebar" id="phase-2-current-rms-bar" value="0">
                                <div class="valuebar-inner bg-success" id="phase-2-current-rms-bar-inner"></div>
                            </div> <span class="spinner-border spinner-border-sm reading-process-spinner" role="status"></span> <span id="phase-2-current-rms-value">0.0</span> A</li>
                        <li>Phase3: <div class="valuebar" id="phase-3-current-rms-bar" value="0">
                                <div class="valuebar-inner bg-success" id="phase-3-current-rms-bar-inner"></div>
                            </div> <span class="spinner-border spinner-border-sm reading-process-spinner" role="status"></span> <span id="phase-3-current-rms-value">0.0</span> A</li>
                    </ul>
                </div>
                <div class="dashboard-group">
                    <details>
                        <summary>Additional</summary>
                        <div class="dashboard-group">
                            <div>
                                <p>Negative sequence current:</p>
                                <div class="valuebar" id="negative-sequence-current-bar" value="0">
                                    <div class="valuebar-inner bg-success" id="negative-sequence-current-bar-inner">
                                    </div>
                                </div> <span id="negative-sequence-current-value">0.0</span> A
                            </div>
                            <div>
                                <p>Zero sequence current:</p>
                                <div class="valuebar" id="zero-sequence-current-bar" value="0">
                                    <div class="valuebar-inner bg-success" id="zero-sequence-current-bar-inner"></div>
                                </div> <span id="zero-sequence-current-value">0.0</span> A
                            </div>
                        </div>

                        <div class="dashboard-group">
                            <table id="dashboard-table-currents">
                                <tr>
                                    <th colspan="2">Current average value:</th>
                                    <th>For time</th>
                                    <th>Max:</th>
                                </tr>
                                <tr>
                                    <td>Phase 1:</td>
                                    <td><span id="avg-current-value-phase-1">0.0</span> A</td>
                                    <td rowspan="3">
                                        <span id="current-average-for-time-value">60.0</span> sec
                                    </td>
                                    <td><span id="max-current-value-phase-1">0.0</span> A</td>
                                </tr>
                                <tr>
                                    <td>Phase 2:</td>
                                    <td><span id="avg-current-value-phase-2">0.0</span> A</td>
                                    <td><span id="max-current-value-phase-2">0.0</span> A</td>
                                </tr>
                                <tr>
                                    <td>Phase 3:</td>
                                    <td><span id="avg-current-value-phase-3">0.0</span> A</td>
                                    <td><span id="max-current-value-phase-3">0.0</span> A</td>
                                </tr>
                            </table>
                        </div>

                        <div class="dashboard-group">
                            <div>Motor start current: <span id="motor-start-current-value">0.0</span> A</div>
                            <div>Overload current: <span id="overload-current-value">0.0</span> A</div>
                        </div>

                    </details>
                </div>
            </div>
            <div class="col-sm">
                <header class="dashboard-header">Voltage (Volt)</header>
                <div class="dashboard-group">
                    <p>Phase voltages active values:</p>
                    <ul>
                        <li>Phase1: <div class="valuebar" id="phase-1-voltage-bar" value="0">
                                <div class="valuebar-inner bg-success" id="phase-1-voltage-bar-inner"></div>
                                <div class="overvaluebar-inner bg-warning" id="phase-1-voltage-bar-over-inner"></div>
                            </div> <span class="spinner-border spinner-border-sm reading-process-spinner" role="status"></span> <span id="phase-1-voltage-value">0.0</span> V</li>
                        <li>Phase2: <div class="valuebar" id="phase-2-voltage-bar" value="0">
                                <div class="valuebar-inner bg-success" id="phase-2-voltage-bar-inner"></div>
                                <div class="overvaluebar-inner bg-warning" id="phase-2-voltage-bar-over-inner"></div>
                            </div> <span class="spinner-border spinner-border-sm reading-process-spinner" role="status"></span> <span id="phase-2-voltage-value">0.0</span> V</li>
                        <li>Phase3: <div class="valuebar" id="phase-3-voltage-bar" value="0">
                                <div class="valuebar-inner bg-success" id="phase-3-voltage-bar-inner"></div>
                                <div class="overvaluebar-inner bg-warning" id="phase-3-voltage-bar-over-inner"></div>
                            </div> <span class="spinner-border spinner-border-sm reading-process-spinner" role="status"></span> <span id="phase-3-voltage-value">0.0</span> V</li>
                    </ul>
                </div>
                <div class="dashboard-group">
                    <details>
                        <summary>Additional</summary>
                        <div>
                            <p>Line voltages active values:</p>
                            <ul>
                                <li>AB:
                                    <div class="valuebar" id="line-1-voltage-bar" value="0">
                                        <div class="valuebar-inner bg-success" id="line-1-voltage-bar-inner"></div>
                                        <div class="overvaluebar-inner bg-warning" id="line-1-voltage-bar-over-inner">
                                        </div>
                                        <div class="overvaluebar2-inner bg-danger" id="line-1-voltage-bar-over2-inner">
                                        </div>
                                    </div>
                                    <span id="line-1-voltage-value">0.0</span> V
                                </li>
                                <li>BC:
                                    <div class="valuebar" id="line-2-voltage-bar" value="0">
                                        <div class="valuebar-inner bg-success" id="line-2-voltage-bar-inner"></div>
                                        <div class="overvaluebar-inner bg-warning" id="line-2-voltage-bar-over-inner">
                                        </div>
                                        <div class="overvaluebar2-inner bg-danger" id="line-2-voltage-bar-over2-inner">
                                        </div>
                                    </div>
                                    <span id="line-2-voltage-value">0.0</span> V
                                </li>
                                <li>CA:
                                    <div class="valuebar" id="line-3-voltage-bar" value="0">
                                        <div class="valuebar-inner bg-success" id="line-3-voltage-bar-inner"></div>
                                        <div class="overvaluebar-inner bg-warning" id="line-3-voltage-bar-over-inner">
                                        </div>
                                        <div class="overvaluebar2-inner bg-danger" id="line-3-voltage-bar-over2-inner">
                                        </div>
                                    </div>
                                    <span id="line-3-voltage-value">0.0</span> V
                                </li>
                            </ul>
                        </div>
                        <p>
                            Negative sequence voltage:
                        <div>
                            <div class="valuebar" id="negative-sequence-voltage-bar" value="0">
                                <div class="valuebar-inner bg-success" id="negative-sequence-voltage-bar-inner"></div>
                            </div> <span id="negative-sequence-voltage-value">0.0</span> V
                        </div>
                        </p>
                        <p>
                            Positive sequence voltage: <span id="positive-sequence-voltage-value">0</span> V
                        </p>
                        <p>
                            Zero sequence voltage: <span id="zero-sequence-voltage-value">0</span> V
                        </p>
                    </details>
                </div>
            </div>
            <div class="col-sm">
                <header class="dashboard-header">Time (sec)</header>
                <div class="dashboard-group">
                    <p>Time before AR:</p>
                    <div class="valuebar" id="time-before-ar-bar" value="0">
                        <div class="valuebar-inner bg-success" id="time-before-ar-bar-inner"></div>
                    </div>
                    <span id="time-before-ar-string"> Off</span>
                </div>
                <div class="dashboard-group">
                    <details>
                        <summary>Additional</summary>
                        <ul>
                            <li>Startup time: <span id="startup-time-value">0</span> sec</li>
                            <li>Time before overload tripping: <span id="time-before-overload-tripping-string">No</span>
                            </li>
                            <li>Wait time after overload deenergize: <span
                                    id="wait-time-after-overload-deenergize-string">No</span></li>
                        </ul>
                    </details>
                </div>

                <div class="dashboard-group">
                    <header class="dashboard-header">Power</header>
                    <ul>
                        <li>Full power: <span id="full-power-value">-</span></li>
                        <li>Active power: <span id="active-power-value">-</span></li>
                        <li>Reactive power: <span id="reactive-power-value">-</span></li>
                        <li>
                            <select id="power-characteristic-value-1" class="power-characteristic"
                                name="power-characteristic-value-1">
                                <option value="no-selection"> -select- </option>
                                <option value="phase-1-full-power">Phase 1 full power</option>
                                <option value="phase-2-full-power">Phase 2 full power</option>
                                <option value="phase-3-full-power">Phase 3 full power</option>
                                <option value="phase-1-active-power">Phase 1 active power</option>
                                <option value="phase-2-active-power">Phase 2 active power</option>
                                <option value="phase-3-active-power">Phase 3 active power</option>
                                <option value="phase-1-reactive-power">Phase 1 reactive power</option>
                                <option value="phase-2-reactive-power">Phase 2 reactive power</option>
                                <option value="phase-3-reactive-power">Phase 3 reactive power</option>
                                <option value="phase-1-cos-phi">Phase 1 cos Phi</option>
                                <option value="phase-2-cos-phi">Phase 2 cos Phi</option>
                                <option value="phase-3-cos-phi">Phase 3 cos Phi</option>
                            </select>
                            <span id="power-show-value-1">
                                -
                            </span>
                        </li>
                        <li>
                            <select id="power-characteristic-value-2" class="power-characteristic"
                                name="power-characteristic-value-2">
                                <option value="no-selection"> -select- </option>
                                <option value="phase-1-full-power">Phase 1 full power</option>
                                <option value="phase-2-full-power">Phase 2 full power</option>
                                <option value="phase-3-full-power">Phase 3 full power</option>
                                <option value="phase-1-active-power">Phase 1 active power</option>
                                <option value="phase-2-active-power">Phase 2 active power</option>
                                <option value="phase-3-active-power">Phase 3 active power</option>
                                <option value="phase-1-reactive-power">Phase 1 reactive power</option>
                                <option value="phase-2-reactive-power">Phase 2 reactive power</option>
                                <option value="phase-3-reactive-power">Phase 3 reactive power</option>
                                <option value="phase-1-cos-phi">Phase 1 cos Phi</option>
                                <option value="phase-2-cos-phi">Phase 2 cos Phi</option>
                                <option value="phase-3-cos-phi">Phase 3 cos Phi</option>
                            </select>
                            <span id="power-show-value-2">
                                -
                            </span>
                        </li>
                        <li>
                            <select id="power-characteristic-value-3" class="power-characteristic"
                                name="power-characteristic-value-3">
                                <option value="no-selection"> -select- </option>
                                <option value="phase-1-full-power">Phase 1 full power</option>
                                <option value="phase-2-full-power">Phase 2 full power</option>
                                <option value="phase-3-full-power">Phase 3 full power</option>
                                <option value="phase-1-active-power">Phase 1 active power</option>
                                <option value="phase-2-active-power">Phase 2 active power</option>
                                <option value="phase-3-active-power">Phase 3 active power</option>
                                <option value="phase-1-reactive-power">Phase 1 reactive power</option>
                                <option value="phase-2-reactive-power">Phase 2 reactive power</option>
                                <option value="phase-3-reactive-power">Phase 3 reactive power</option>
                                <option value="phase-1-cos-phi">Phase 1 cos Phi</option>
                                <option value="phase-2-cos-phi">Phase 2 cos Phi</option>
                                <option value="phase-3-cos-phi">Phase 3 cos Phi</option>
                            </select>
                            <span id="power-show-value-3">-</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="substrat" id="substarat-popup-menu"></div>
    <div class="popup-menu" id="ubz-parameters-menu">
        <div class="popup-header-background">
            <button type="button" class="close close-button" aria-label="Close" id="ubz-parameters-close"><span
                    aria-hidden="true">&times;</span></button>
            <header class="dashboard-header">UBZ parameters menu</header>
        </div>

        <div id="popup-menu-items">
            <details>
                <summary>Transformers</summary>
                <div class="ubz-parameter">[150] CT in use <input type="number" class="ubz-params-input" min="0" max="1"
                        value="0" id="ubz-param-input-150"></div>
                <div class="ubz-parameter">[151] CT rated current, A <input type="number" class="ubz-params-input"
                        min="20" max="800" value="100" id="ubz-param-input-151"></div>
            </details>
            <details>
                <summary>Miscellaneous</summary>
                <div class="ubz-parameter">[152] Motor rated current, A <input type="number" class="ubz-params-input"
                        min="0" max="630" value="0" id="ubz-param-input-152"></div>
                <div class="ubz-parameter">[153] Average current measurement time, seconds <input type="number"
                        class="ubz-params-input" min="10" max="600" value="60" id="ubz-param-input-153"></div>
            </details>
            <details>
                <summary>Overcurrent protection</summary>
                <div class="ubz-parameter">[154] Overcurrent protection type <input type="number"
                        class="ubz-params-input" min="0" max="5" value="0" id="ubz-param-input-154"></div>
                <div class="ubz-parameter">[155] Overcurrent protection tripping setting value, ratio <input
                        type="number" class="ubz-params-input" min="0.8" max="9.0" value="4.0" step="0.1"
                        id="ubz-param-input-155"></div>
                <div class="ubz-parameter">[156] Overcurrent protection tripping delay, seconds <input type="number"
                        class="ubz-params-input" min="0.3" max="600" value="10" step="0.1" id="ubz-param-input-156">
                </div>
                <div class="ubz-parameter">[157] Protection permission <input type="number" class="ubz-params-input"
                        min="0" max="2" value="2" id="ubz-param-input-157"></div>
                <div class="ubz-parameter">[158] Order of overcurrent protection tripping relative to thermal
                    overload protection <input type="number" class="ubz-params-input" min="0" max="1" value="1"
                        id="ubz-param-input-158"></div>
            </details>
            <details>
                <summary>Protection against ground faults</summary>
                <div class="ubz-parameter">[159] Current fault tripping setting, A <input type="number"
                        class="ubz-params-input" min="0.3" max="5.0" value="0.5" step="0.1" id="ubz-param-input-159">
                </div>
                <div class="ubz-parameter">[160] Protection tripping delay, seconds <input type="number"
                        class="ubz-params-input" min="0.3" max="2.0" value="1.0" step="0.1" id="ubz-param-input-160">
                </div>
                <div class="ubz-parameter">[161] Protection permission <input type="number" class="ubz-params-input"
                        min="0" max="2" value="2" id="ubz-param-input-161"></div>
            </details>
            <details>
                <summary>Negative sequence current protection</summary>
                <div class="ubz-parameter">[162] Tripping setting, % <input type="number" class="ubz-params-input"
                        min="5" max="20" value="10" id="ubz-param-input-162"></div>
                <div class="ubz-parameter">[163] Protection tripping delay, seconds <input type="number"
                        class="ubz-params-input" min="0.3" max="10" value="5" step="0.1" id="ubz-param-input-163">
                </div>
                <div class="ubz-parameter">[164] Protection permission <input type="number" class="ubz-params-input"
                        min="0" max="2" value="2" id="ubz-param-input-164"></div>
            </details>
            <details>
                <summary>Analysis of causes for negative sequence current protection tripping</summary>
                <div class="ubz-parameter">[165] Negative sequence current ratio divided by negative sequence
                    voltage ratio <input type="number" class="ubz-params-input" min="2" max="4" value="2"
                        id="ubz-param-input-165"></div>
                <div class="ubz-parameter">[166] Analysis permission <input type="number" class="ubz-params-input"
                        min="0" max="1" value="1" id="ubz-param-input-166"></div>
            </details>
            <details>
                <summary>Thermal overload (motor thermal model)</summary>
                <div class="ubz-parameter">[167] Protection permission <input type="number" class="ubz-params-input"
                        min="0" max="2" value="2" id="ubz-param-input-167"></div>
                <div class="ubz-parameter">[168] Double overcurrent overload protection tripping time, seconds
                    <input type="number" class="ubz-params-input" min="10" max="120" value="60"
                        id="ubz-param-input-168">
                </div>
                <div class="ubz-parameter">[169] Time increase ratio with a stopped motor <input type="number"
                        class="ubz-params-input" min="1" max="4" value="1" step="0.1" id="ubz-param-input-169">
                </div>
            </details>
            <details>
                <summary>Undercurrent phase protection</summary>
                <div class="ubz-parameter">[170] Tripping setting, % <input type="number" class="ubz-params-input"
                        min="11" max="90" value="20" id="ubz-param-input-170"></div>
                <div class="ubz-parameter">[171] Protection tripping delay, seconds <input type="number"
                        class="ubz-params-input" min="1" max="100" value="5" id="ubz-param-input-171"></div>
                <div class="ubz-parameter">[172] Protection permission <input type="number" class="ubz-params-input"
                        min="0" max="2" value="2" id="ubz-param-input-172"></div>
            </details>
            <details>
                <summary>Delayed start, rotor blocking</summary>
                <div class="ubz-parameter">[173] Tripping setting, ratio <input type="number" class="ubz-params-input"
                        min="1.5" max="7" value="5" step="0.1" id="ubz-param-input-173">
                </div>
                <div class="ubz-parameter">[174] Delayed start protection tripping delay, seconds <input type="number"
                        class="ubz-params-input" min="1" max="600" value="10" id="ubz-param-input-174"></div>
                <div class="ubz-parameter">[175] Rotor blocking protection tripping delay, seconds <input type="number"
                        class="ubz-params-input" min="0.3" max="300" value="1" step="0.1" id="ubz-param-input-175">
                </div>
                <div class="ubz-parameter">[176] Protection permission <input type="number" class="ubz-params-input"
                        min="0" max="2" value="1" id="ubz-param-input-176"></div>
            </details>
            <details>
                <summary>Voltage protection</summary>
                <div class="ubz-parameter">[177] Minimum line voltage, V <input type="number" class="ubz-params-input"
                        min="270" max="415" value="320" id="ubz-param-input-177"></div>
                <div class="ubz-parameter">[178] Minimum voltage protection tripping delay, seconds <input type="number"
                        class="ubz-params-input" min="5" max="30" value="10" id="ubz-param-input-178">
                </div>
                <div class="ubz-parameter">[179] Minimum voltage protection permission <input type="number"
                        class="ubz-params-input" min="0" max="2" value="2" id="ubz-param-input-179"></div>
                <div class="ubz-parameter">[180] Maximum line voltage, V <input type="number" class="ubz-params-input"
                        min="330" max="475" value="415" id="ubz-param-input-180"></div>
                <div class="ubz-parameter">[181] Maximum voltage protection tripping delay, seconds <input type="number"
                        class="ubz-params-input" min="1" max="10" value="2" id="ubz-param-input-181">
                </div>
                <div class="ubz-parameter">[182] Maximum voltage protection permission <input type="number"
                        class="ubz-params-input" min="0" max="1" value="2" id="ubz-param-input-182"></div>
                <div class="ubz-parameter">[183] Line voltage imbalance, V <input type="number" class="ubz-params-input"
                        min="15" max="120" value="35" id="ubz-param-input-183"></div>
                <div class="ubz-parameter">[184] Line voltage imbalance tripping delay, seconds <input type="number"
                        class="ubz-params-input" min="1" max="30" value="5" id="ubz-param-input-184"></div>
                <div class="ubz-parameter">[185] Line voltage imbalance protection permission <input type="number"
                        class="ubz-params-input" min="0" max="2" value="2" id="ubz-param-input-185"></div>
                <div class="ubz-parameter">[186] Phase sequence order protection permission <input type="number"
                        class="ubz-params-input" min="0" max="2" value="1" id="ubz-param-input-186"></div>
            </details>
            <details>
                <summary>Motor operation and automatic reclosing</summary>
                <div class="ubz-parameter">[187] ARC time after undercurrent protection tripping, seconds <input
                        type="number" class="ubz-params-input" min="0" max="900" value="600" id="ubz-param-input-187">
                </div>
                <div class="ubz-parameter">[188] ARC time, seconds <input type="number" class="ubz-params-input" min="0"
                        max="900" value="5" id="ubz-param-input-188"></div>
                <div class="ubz-parameter">[189] ARC prohibition for all faults (except voltage faults) <input
                        type="number" class="ubz-params-input" min="0" max="1" value="1" id="ubz-param-input-189">
                </div>
                <div class="ubz-parameter">[190] Motor operation permission after UBZ power-on<input type="number"
                        class="ubz-params-input" min="0" max="2" value="1" id="ubz-param-input-190"></div>
                <div class="ubz-parameter">[191] Motor control via UBZ front panel <input type="number"
                        class="ubz-params-input" min="0" max="3" value="0" id="ubz-param-input-191"></div>
            </details>
            <details>
                <summary>Temperature control</summary>
                <div class="ubz-parameter">[192] Temperature sensor 1 type and temperature control permission <input
                        type="number" class="ubz-params-input" min="0" max="2" value="0" id="ubz-param-input-192">
                </div>
                <div class="ubz-parameter">[193] Motor de-energizing temperature <input type="number"
                        class="ubz-params-input" min="0" max="100" value="80" id="ubz-param-input-193"></div>
                <div class="ubz-parameter">[194] Sensor 1 temperature correction <input type="number"
                        class="ubz-params-input" min="-9" max="9" value="0" id="ubz-param-input-194"></div>
                <div class="ubz-parameter">[195] Temperature sensor 2 type and temperature control permission <input
                        type="number" class="ubz-params-input" min="0" max="3" value="0" id="ubz-param-input-195">
                </div>
                <div class="ubz-parameter">[196] Motor de-energizing temperature <input type="number"
                        class="ubz-params-input" min="0" max="220" value="180" id="ubz-param-input-196"></div>
                <div class="ubz-parameter">[197] Warning temperature <input type="number" class="ubz-params-input"
                        min="0" max="220" value="170" id="ubz-param-input-197"></div>
                <div class="ubz-parameter">[198] Sensor 2 temperature correction <input type="number"
                        class="ubz-params-input" min="-9" max="9" value="0" id="ubz-param-input-198"></div>
                <div class="ubz-parameter">[199] ARC after protection tripping <input type="number"
                        class="ubz-params-input" min="1" max="2" value="2" id="ubz-param-input-199"></div>
                <div class="ubz-parameter">[200] Reaction to temperaturesensor failure <input type="number"
                        class="ubz-params-input" min="0" max="1" value="0" id="ubz-param-input-200"></div>
            </details>
            <details>
                <summary>Motor insulation resistance</summary>
                <div class="ubz-parameter">[201] Minimum motor insulation resistance <input type="number"
                        class="ubz-params-input" min="0" max="20" value="5" step="5" id="ubz-param-input-201"></div>
            </details>
            <details>
                <summary>Miscellaneous</summary>
                <div class="ubz-parameter">[202] Minimal number of set parameters mode <input type="number"
                        class="ubz-params-input" min="0" max="1" value="1" id="ubz-param-input-202"></div>
                <div class="ubz-parameter">[203] Indication on UBZ display before motor power on <input type="number"
                        class="ubz-params-input" min="0" max="2" value="1" id="ubz-param-input-203">
                </div>
                <div class="ubz-parameter">[204] Parameter indication mode <input type="number" class="ubz-params-input"
                        min="0" max="1" value="1" id="ubz-param-input-204"></div>
                <div class="ubz-parameter">[205] Functional relay operation mode <input type="number"
                        class="ubz-params-input" min="0" max="2" value="0" id="ubz-param-input-205"></div>
                <div class="ubz-parameter">[206] Timer, seconds <input type="number" class="ubz-params-input" min="0"
                        max="300" value="30" id="ubz-param-input-206"></div>
                <div class="ubz-parameter">[207] Equipment uptime, days <input type="number" class="ubz-params-input"
                        min="0" max="999" value="0" disabled id="ubz-param-input-207">
                </div>
                <div class="ubz-parameter">[208] Motor uptime, days <input type="number" class="ubz-params-input"
                        min="0" max="999" value="0" disabled id="ubz-param-input-208"></div>
                <div class="ubz-parameter">[209] User access code <input type="number" class="ubz-params-input" min="0"
                        max="9" value="0" disabled id="ubz-param-input-209"></div>
                <div class="ubz-parameter">[210] Engineer access code <input type="number" class="ubz-params-input"
                        min="0" max="999" value="123" disabled id="ubz-param-input-210"></div>
                <div class="ubz-parameter">[211] Reset to factory settings <input type="number" class="ubz-params-input"
                        min="0" max="1" value="0" id="ubz-param-input-211"></div>
            </details>
            <details>
                <summary>Serial interface parameters (RS-485/ RS-232)</summary>
                <div class="ubz-parameter">[212] UBZ communication address <input type="number" class="ubz-params-input"
                        min="1" max="247" value="1" disabled id="ubz-param-input-212">
                </div>
                <div class="ubz-parameter">[213] Transfer rate <input type="number" class="ubz-params-input" min="0"
                        max="1" value="0" id="ubz-param-input-213"></div>
                <div class="ubz-parameter">[214] Adapter reaction to lossof link <input type="number"
                        class="ubz-params-input" min="0" max="3" value="0" id="ubz-param-input-214"></div>
                <div class="ubz-parameter">[215] Response timeout detection, seconds <input type="number"
                        class="ubz-params-input" min="0" max="120" value="0" id="ubz-param-input-215"></div>
                <div class="ubz-parameter">[216] UBZ communication via serial channel <input type="number"
                        class="ubz-params-input" min="0" max="2" value="0" id="ubz-param-input-216"></div>
                <div class="ubz-parameter">[217] Device version <input type="number" class="ubz-params-input" min="21"
                        max="21" value="21" disabled id="ubz-param-input-217"></div>
            </details>
            <details>
                <summary>Functional relay mode parameters. Star-delta mode.</summary>
                <div class="ubz-parameter">[218] Switching, seconds <input type="number" class="ubz-params-input"
                        min="0.1" max="2.0" value="0.4" step="0.1" id="ubz-param-input-218"></div>
            </details>
            <details>
                <summary>Motor phase (phases) loss, with current control</summary>
                <div class="ubz-parameter">[219] Phase loss protection tripping delay, seconds <input type="number"
                        class="ubz-params-input" min="0.3" max="10" value="0.5" step="0.1" id="ubz-param-input-219">
                </div>
                <div class="ubz-parameter">[220] Protection permission <input type="number" class="ubz-params-input"
                        min="0" max="2" value="1" id="ubz-param-input-220"></div>
                <div class="ubz-parameter">[221] Remote motor start andstop using the RS-232/RS485 interfaces<input
                        type="number" class="ubz-params-input" min="0" max="2" value="0" id="ubz-param-input-221">
                </div>
            </details>
            <details>
                <summary>0-20 mA analog input operation</summary>
                <div class="ubz-parameter">[222] Upper thershold, mA <input type="number" class="ubz-params-input"
                        min="0" max="20.0" value="10.0" step="0.1" id="ubz-param-input-222"></div>
                <div class="ubz-parameter">[223] Lower thershold, mA <input type="number" class="ubz-params-input"
                        min="0" max="20.0" value="1.0" step="0.1" id="ubz-param-input-223"></div>
                <div class="ubz-parameter">[224] Control algorithm <input type="number" class="ubz-params-input" min="0"
                        max="2" value="0" id="ubz-param-input-224"></div>
                <div class="ubz-parameter">[225] Fault logging <input type="number" class="ubz-params-input" min="0"
                        max="1" value="0" id="ubz-param-input-225"></div>
            </details>
            <details>
                <summary>0-10 V analog input operation</summary>
                <div class="ubz-parameter">[226] Upper thershold, V <input type="number" class="ubz-params-input"
                        min="0" max="10.0" value="5.0" input="0.1" id="ubz-param-input-226"></div>
                <div class="ubz-parameter">[227] Lower thershold, V <input type="number" class="ubz-params-input"
                        min="0" max="10.0" value="1.0" input="0.1" id="ubz-param-input-227"></div>
                <div class="ubz-parameter">[228] Control algorithm <input type="number" class="ubz-params-input" min="0"
                        max="2" value="0" id="ubz-param-input-228"></div>
                <div class="ubz-parameter">[229] Fault logging <input type="number" class="ubz-params-input" min="0"
                        max="1" value="0" id="ubz-param-input-229"></div>
            </details>
            <details>
                <summary>Control of external MS</summary>
                <div class="ubz-parameter">[230] Control of external MS working order <input type="number"
                        class="ubz-params-input" min="0" max="1" value="1" id="ubz-param-input-230"></div>
            </details>
        </div>

        <div class="popup-footer-background">
            <div>
                <input type="checkbox" id="checkbox-write-only-modified-ubz-params" checked> Write only modified
                parameters
            </div>
            <div>
                <button type="button" class="btn btn-vis" id="button-write-ubz-params">Write parameters to
                    device</button>
                <button type="button" class="btn btn-vis" id="button-read-ubz-params">Read parameters from
                    device</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.0.1"></script>

<!-- Alarms defined in device -->
<script type="text/javascript">
    const alarms = [
        {
            name: "Phase overcurrent",
            mnemonic: "A,<sup>=</sup>",
            address: 241,
            bit: 0,
            valueAddress: 300,
        },
        {
            name: "Thermal overload",
            mnemonic: "Adt",
            address: 241,
            bit: 1,
            valueAddress: 301,
        },
        {
            name: "Ground fault (zero sequence current)",
            mnemonic: "A,_",
            address: 241,
            bit: 2,
            valueAddress: 302,
        },
        {
            name: "Exceeded multiplicity", // ???
            mnemonic: "A,O",
            address: 241,
            bit: 3,
            valueAddress: 303,
        },
        {
            name: "Negative sequence current",
            mnemonic: "A,o",
            address: 241,
            bit: 4,
            valueAddress: 304,
        },
        {
            name: "Phase undercurrent",
            mnemonic: "A,<sub>=</sub>",
            address: 241,
            bit: 5,
            valueAddress: 305,
        },
        {
            name: "Delayed start",
            mnemonic: "APP",
            address: 241,
            bit: 6,
            valueAddress: 306,
        },
        {
            name: "Rotor blocking",
            mnemonic: "APb",
            address: 241,
            bit: 7,
            valueAddress: 307,
        },
        {
            name: "Temperature threshold at sensor 1",
            mnemonic: "At1",
            address: 241,
            bit: 8,
            valueAddress: 308,
        },
        {
            name: "Temperature threshold at sensor 2",
            mnemonic: "At2",
            address: 241,
            bit: 9,
            valueAddress: 309,
        },
        {
            name: "Phase sequence",
            mnemonic: "AUЧ",
            address: 241,
            bit: 10,
            valueAddress: 310,
        },
        {
            name: "External MS",
            mnemonic: "ACo",
            address: 241,
            bit: 11,
            valueAddress: 311,
        },
        {
            name: "Line undervoltage",
            mnemonic: "AU<sub>=</sub>",
            address: 241,
            bit: 12,
            valueAddress: 312,
        },
        {
            name: "Line overvoltage",
            mnemonic: "AU<sup>=</sup>",
            address: 241,
            bit: 13,
            valueAddress: 313,
        },
        {
            name: "Phase imbalance",
            mnemonic: "AU<sup>п<\sup>",
            address: 241,
            bit: 14,
            valueAddress: 314,
        },
        {
            name: "Motor coil insulation resistance",
            mnemonic: "Ar,",
            address: 241,
            bit: 15,
            valueAddress: 315,
        },
        {
            name: "Remote control channel fault",
            mnemonic: "AdU",
            address: 242,
            bit: 0,
            valueAddress: undefined,
        },
        {
            name: "emergency motor stop without ARC",
            mnemonic: "EAd",
            address: 242,
            bit: 1,
            valueAddress: undefined,
        },
        {
            name: "emergency motor stop with ARC",
            mnemonic: "EOd",
            address: 242,
            bit: 2,
            valueAddress: undefined,
        },
        {
            name: "Short circuit of temperature sensor 1",
            mnemonic: "ES1",
            address: 242,
            bit: 3,
            valueAddress: undefined,
        },
        {
            name: "Breakout of temperature sensor 1",
            mnemonic: "EO1",
            address: 242,
            bit: 4,
            valueAddress: undefined,
        },
        {
            name: "Short circuit of temperature sensor 2",
            mnemonic: "ES2",
            address: 242,
            bit: 5,
            valueAddress: undefined,
        },
        {
            name: "Breakout of temperature sensor 2",
            mnemonic: "EO2",
            address: 242,
            bit: 6,
            valueAddress: undefined,
        },
        {
            name: "Phase loss",
            mnemonic: "E,U",
            address: 242,
            bit: 7,
            valueAddress: undefined,
        },
        {
            name: "EEPROM destruction",
            mnemonic: "EEP",
            address: 242,
            bit: 8,
            valueAddress: undefined,
        },
        {
            name: "0-20 mA analog input",
            mnemonic: "AA,",
            address: 242,
            bit: 9,
            valueAddress: 325,
        },
        {
            name: "0-10 V analog input",
            mnemonic: "AAU",
            address: 242,
            bit: 10,
            valueAddress: 326,
        },
    ];

    const ALARM_TYPES_NUMBER = alarms.length;

    function faultCodeToName(code) {
        return alarms[code].name;
    }
</script>

<!-- Registers processing -->
<script type="text/javascript">
    const API_TOKEN = document.querySelector(".vis-view").getAttribute("apitoken");
    const API_BASE_URL = document.querySelector(".vis-view").getAttribute("apibaseurl");
    const CONTAINER = document.querySelector("#ubz-vis-container");
    const DEVICE_ID = CONTAINER.querySelector("alias").getAttribute("device").replace("#", "");

    async function postResponse(body, url) {
        const res = await new Promise((resolve, reject) => {
            const request = new XMLHttpRequest();
            request.onload = function () {
                const data = JSON.parse(request.response);
                resolve(data);
            }

            request.onerror = function (err) {
                console.error(err);
                reject(err)
            }

            request.open("POST", url);
            request.setRequestHeader("authorization", `token ${API_TOKEN}`);
            request.setRequestHeader("Content-Type", "application/json");
            request.send(JSON.stringify(body));
        });

        return res;
    }

    async function getResponse(url) {
        const res = await new Promise((resolve, reject) => {
            const request = new XMLHttpRequest();
            request.onload = function () {
                const data = JSON.parse(request.response);
                resolve(data);
            }

            request.onerror = function (err) {
                console.error(err);
                reject(err)
            }

            request.open("GET", url);
            request.setRequestHeader("authorization", `token ${API_TOKEN}`);
            request.setRequestHeader("Content-Type", "application/json");
            request.send();
        });

        return res;
    }

    async function rawReadRegs(address, registersNum) {
        const deviceInfo = await getResponse(`${API_BASE_URL}/v1/device/${DEVICE_ID}/`);

        const body = {
            deviceModbusId: deviceInfo.modbusUnitId,
            address: address,
            kind: "holding",
            registersNum: registersNum,
            connection: {
                kind: "net-id",
                networkId: deviceInfo.netId,
            }
        };

        const res = await postResponse(body, `${API_BASE_URL}/v1/raw/read-register-group/`);
        return res;
    }

    async function writeRegValues(address, values) {
        const deviceInfo = await getResponse(`${API_BASE_URL}/v1/device/${DEVICE_ID}/`);

        const body = {
            deviceModbusId: deviceInfo.modbusUnitId,
            address: address,
            kind: "holding",
            value: values,
            connection: {
                kind: "net-id",
                networkId: deviceInfo.netId,
            }
        };

        const res = await postResponse(body, `${API_BASE_URL}/v1/raw/write-register-group/`);
        return res;
    }

    async function readRegFromDb(reg) {
        const deviceInfo = await getResponse(`${API_BASE_URL}/v1/device/${DEVICE_ID}/`);

        const netId = deviceInfo.netId;
        const netInfo = await getResponse(`${API_BASE_URL}/v1/net/${netId}/`);

        const orgId = netInfo.orgId;

        const bodyParam = CONTAINER.querySelector("alias").getAttribute("device") + ">" + reg.toString();

        let paramId = await postResponse(bodyParam, `${API_BASE_URL}/v1/org/${orgId}/params/get-id-by-reference/`);

        const pointsLimit = 20;

        return await getResponse(`${API_BASE_URL}/v1/readings/get/?paramId=${paramId}&pointsLimit=${pointsLimit}`);
    }

    async function readBit(address, bitPosition) {
        if (bitPosition < 0 || bitPosition > 15 || bitPosition == undefined) {
            console.log("can't process the bit position");
            return NaN;
        }
        const rawReg = await rawReadRegs(address, 1);
        if (rawReg.ok) {
            return extractBitValue(rawReg.ok[0], bitPosition);
        } else {
            return undefined;
        }
    }

    function extractBitValue(value, bitPosition) {
        const bitValue = (value >>> bitPosition) & 1;
        return bitValue;
    }
</script>

<!-- Event fault class -->
<script type="text/javascript">
    class EventFault {
        constructor() {
            this.code = undefined;
            this.value = undefined;
            this.time = undefined;
        }

        toString() {
            return "code: " + this.code.toString() + "\nvalue: " + this.value.toString() + "\ntime: " + this.time.toString() + "\n";
        }

        isUndefined() {
            return this.code == undefined && this.value == undefined && this.time == undefined;
        }
    }

    async function processEventLog() {
        let eventLog = [new EventFault(), new EventFault(), new EventFault(), new EventFault(), new EventFault()];
        const eventLogRawRegs = await rawReadRegs(243, (4 * 5));
        if (eventLogRawRegs.ok) {
            for (let i = 0; i < 5; i++) {
                eventLog[i].code = eventLogRawRegs.ok[i * 4];
                eventLog[i].value = eventLogRawRegs.ok[i * 4 + 1];
                eventLog[i].time = (eventLogRawRegs.ok[i * 4 + 2] << 16) + eventLogRawRegs.ok[i * 4 + 3];
            }
        }
        return eventLog;
    }

    async function getTimeStrFromSwitchingOn() {
        const timeRegs = await rawReadRegs(98, 2);
        if (timeRegs.ok) {
            const regHi = timeRegs.ok[0];
            const regLo = timeRegs.ok[1];
            const time = (regHi << 16) + regLo;
            const h = Math.floor(time / 60);
            const m = time % 60;
            const hStr = (h < 10) ? "0" + h.toString() : h.toString();
            const mStr = (m < 10) ? "0" + m.toString() : m.toString();
            return hStr + " h : " + mStr + " m";
        } else {
            return "cannot read time from power on device";
        }
    }
</script>

<!-- Report HTML creation -->
<script type="text/javascript">
    var ubzCommunicationAddress = undefined;

    function eventToReadableStrings(event) {
        let out = {
            timeStr: "",
            valueStr: "",
        };

        // "When UBZ is powered on, 5000000 is written into the registers used to store fault time." - documentation
        if (event.time == 5000000) {
            out.timeStr = "-- h : -- m";
            out.valueStr = event.value.toString();
        } else {
            let h = event.time / 3600;
            let m = (event.time % 3600) / 60;
            out.timeStr = h.toString() + " h : " + m.toString() + " m";
        }

        if (event.code == 10 && event.value == 10000) {
            out.valueStr = "------";
        } else {
            out.valueStr = event.value.toString();
        }

        return out;
    }

    async function createReportURL() {
        let eventlog = await processEventLog();
        if (eventlog[0].isUndefined() && eventlog[1].isUndefined() && eventlog[2].isUndefined() && eventlog[3].isUndefined() && eventlog[4].isUndefined()) {
            return "";
        }
        const now = new Date();

        let eventLogString =
            "<html>\
<head>\
    <title>Log of failures UBZ</title>\
</head>\
<body bgcolor='#000080' text='#FFFFFF' link='#C1E0FF' vlink='#C1E0FF' alink='#F0FBFF' style='font-family: Arial'>\
<p><u><strong><big><big>Log of failures UBZ</big></big></strong></u><br>It is generated ";

        eventLogString += now.toDateString() + " at " + now.toLocaleTimeString() + "<p>\
    The device name: UBZ-302 (standart) <br>\
    Firmware version: ";

        const firmwareVersionRaw = await rawReadRegs(217, 1);
        if (firmwareVersionRaw.ok) {
            eventLogString += firmwareVersionRaw.ok[0].toString();
        } else {
            eventLogString += "cannot read firmware version";
        }

        eventLogString += "<br>Address: ";
        if (ubzCommunicationAddress) {
            eventLogString += ubzCommunicationAddress.toString() + "\n";
        } else {
            eventLogString += "undefined\n";
        }

        let timeFromPowerOnStr = await getTimeStrFromSwitchingOn();
        eventLogString +=
            "<br>Time from power on device: ";
        eventLogString += timeFromPowerOnStr;

        eventLogString += "<br></p>\
        <table border='0' width='100%'>\
 <tr>\
  <td bgcolor='#0040D5' align='left'><strong><font color=#FFFFFF>#</font></strong></td>\
  <td bgcolor='#0040D5' align='left'><strong><font color=#FFFFFF></font></strong></td>\
  <td bgcolor='#0040D5' align='left'><strong><font color=#FFFFFF>The failure name</font></strong></td>\
  <td bgcolor='#0040D5' align='left'><strong><font color=#FFFFFF></font></strong></td>\
  <td bgcolor='#0040D5' align='left'><strong><font color=#FFFFFF>Failure time</font></strong></td>\
  <td bgcolor='#0040D5' align='left'><strong><font color=#FFFFFF></font></strong></td>\
  <td bgcolor='#0040D5' align='left'><strong><font color=#FFFFFF>Value</font></strong></td>\
  <td bgcolor='#0040D5' align='left'><strong><font color=#FFFFFF></font></strong></td>\
  <td bgcolor='#0040D5' align='left'><strong><font color=#FFFFFF>Code</font></strong></td>\
 </tr> ";

        for (let i = 0; i < 5; i++) {
            const eventReadableStrings = eventToReadableStrings(eventlog[i]);
            let timeStr = "";
            if (eventlog[i].time == 0) {
                timeStr = timeFromPowerOnStr;
            } else {
                timeStr = eventReadableStrings.timeStr;
            }
            eventLogString +=
                "<tr>\
<td valign='middle' align='left' bgcolor='#8080FF'>&nbsp;<font color=#FFFFFF>" + (i + 1).toString() + "</font>&nbsp;</td>\
<td valign='middle' align='left' bgcolor='#8080FF'>&nbsp;<font color=#FFFFFF></font>&nbsp;</td>\
<td valign='middle' align='left' bgcolor='#8080FF'>&nbsp;<font color=#FFFFFF>" + faultCodeToName(eventlog[i].code) + "</font>&nbsp;</td>\
<td valign='middle' align='left' bgcolor='#8080FF'>&nbsp;<font color=#FFFFFF></font>&nbsp;</td>\
<td valign='middle' align='left' bgcolor='#8080FF'>&nbsp;<font color=#FFFFFF>" + timeStr + "</font>&nbsp;</td>\
<td valign='middle' align='left' bgcolor='#8080FF'>&nbsp;<font color=#FFFFFF></font>&nbsp;</td>\
<td valign='middle' align='left' bgcolor='#8080FF'>&nbsp;<font color=#FFFFFF>" + eventReadableStrings.valueStr + "</font>&nbsp;</td>\
<td valign='middle' align='left' bgcolor='#8080FF'>&nbsp;<font color=#FFFFFF></font>&nbsp;</td>\
<td valign='middle' align='left' bgcolor='#8080FF'>&nbsp;<font color=#FFFFFF>" + eventlog[i].code.toString() + "</font>&nbsp;</td>\
</tr>";
        }

        eventLogString +=
            "</table><p>Failure time - is measured from the moment of power on UBZ and till the moment of occurrence of failure.</p>\
<p>Failures are sorted with a bottom upwards by a stack method (i.e. the last failure is from above).</p>\
</body>\
</html>";

        return URL.createObjectURL(new Blob([eventLogString], { type: 'text/html' }));
    }
</script>

<!-- Misc. -->
<script type="text/javascript">
    function temperatureSensorReadable(value) {
        if (value == 5000) {
            return "Off";
        } else if (value <= 2010 && value >= 1990) {
            return "Fault";
        } else if (value <= 1010 && value >= 990) {
            return "S/C"
        } else if (value <= 220 && value >= -40) {
            return String(value);
        } else {
            return "Und.";
        }
    }

    function sinFromCos(cosValue) {
        return Math.sqrt(1 - Math.pow(cosValue, 2));
    }

    function timeString(dateTime) {
        const hoursNum = dateTime.getHours();
        let hoursStr = hoursNum.toString();
        if (hoursNum < 10) {
            hoursStr = "0" + hoursStr;
        }

        const minutesNum = dateTime.getMinutes();
        let minutesStr = minutesNum.toString();
        if (minutesNum < 10) {
            minutesStr = "0" + minutesStr;
        }

        const secondsNum = dateTime.getSeconds();
        let secondsStr = secondsNum.toString();
        if (secondsNum < 10) {
            secondsStr = "0" + secondsStr;
        }

        return hoursStr + ":" + minutesStr + ":" + secondsStr;
    }

    function timeStringFromMillis(milliseconds) {
        let hoursNum = Math.floor(milliseconds / 3600000);
        let hoursStr = hoursNum.toString();
        if (hoursNum < 10) {
            hoursStr = "0" + hoursStr;
        }

        const minutesNum = Math.floor((milliseconds % 3600000) / 60000);
        let minutesStr = minutesNum.toString();
        if (minutesNum < 10) {
            minutesStr = "0" + minutesStr;
        }

        const secondsNum = Math.floor((milliseconds % 60000) / 1000);
        let secondsStr = secondsNum.toString();
        if (secondsNum < 10) {
            secondsStr = "0" + secondsStr;
        }

        return hoursStr + ":" + minutesStr + ":" + secondsStr;
    }

    function activateExternalCTsettings() {
        if (document.querySelector("#external-ct-current").disabled) {
            document.querySelector("#external-ct-current").disabled = false;
        }
        if (document.querySelector("#motor-rated-current").disabled) {
            document.querySelector("#motor-rated-current").disabled = false;
        }
    }

    function deactivateExternalCTsettings() {
        if (!(document.querySelector("#external-ct-current").disabled)) {
            document.querySelector("#external-ct-current").disabled = true;
        }
        if (!(document.querySelector("#motor-rated-current").disabled)) {
            document.querySelector("#motor-rated-current").disabled = true;
        }
    }

    function determineHeatgraphColor(value) {
        let color = "";

        if (value >= 100) {
            color = "rgba(200, 50, 50, 1)";
        } else if (value >= 66) {
            color = "rgba(150, 150, 50, 1)";
        } else {
            color = "rgba(50, 50, 200, 1)";
        }

        return color;
    }

    function switchableGraphsByCheckbox(checkboxSelector, id1Selector, id2Selector) {
        let checkbox = document.querySelector(checkboxSelector);
        checkbox.addEventListener("change", function () {
            if (checkbox.checked) {
                document.querySelector(id1Selector).style.display = 'none';
                document.querySelector(id2Selector).style.display = 'block';
            } else {
                document.querySelector(id1Selector).style.display = 'block';
                document.querySelector(id2Selector).style.display = 'none';
            }
        })
    }
</script>

<!-- Multicolor bar processing -->
<script type="text/javascript">
    function barValue(barId, maxValue, threshold1, threshold2) {
        const v = document.querySelector(barId).value;
        const widthPercentage = 100 * v / maxValue;
        const innerBarId = barId + '-inner';

        let threshold1Percentage = undefined;
        let threshold2Percentage = undefined;

        if ((threshold2 !== undefined) && (threshold1 !== undefined)) {
            threshold1Percentage = 100 * threshold1 / maxValue;
            threshold2Percentage = 100 * threshold2 / maxValue;

            const innerOverBarId = barId + '-over-inner';
            const innerOver2BarId = barId + '-over2-inner';

            if (widthPercentage <= threshold1Percentage) {
                const widthPercentageStr = widthPercentage.toFixed(0) + '%';
                document.querySelector(innerBarId).style.width = widthPercentageStr;
                document.querySelector(innerOverBarId).style.width = "0%";
                document.querySelector(innerOver2BarId).style.width = "0%";
            } else if (widthPercentage <= threshold2Percentage) {
                const widthPercentageStr = threshold1Percentage.toFixed(0) + '%';
                document.querySelector(innerBarId).style.width = widthPercentageStr;
                const widthPercentageOverStr = (widthPercentage - threshold1Percentage).toFixed(0) + '%';
                document.querySelector(innerOverBarId).style.width = widthPercentageOverStr;
                document.querySelector(innerOver2BarId).style.width = "0%";
            } else if (widthPercentage <= 100) {
                const widthPercentageStr = threshold1Percentage.toFixed(0) + '%';
                document.querySelector(innerBarId).style.width = widthPercentageStr;
                const widthPercentageOverStr = (threshold2Percentage - threshold1Percentage).toFixed(0) + '%';
                document.querySelector(innerOverBarId).style.width = widthPercentageOverStr;
                const widthPercentageOver2Str = (widthPercentage - threshold2Percentage).toFixed(0) + '%';
                document.querySelector(innerOver2BarId).style.width = widthPercentageOver2Str;
            }
        } else if (threshold1 !== undefined) {
            threshold1Percentage = 100 * threshold1 / maxValue;

            const innerOverBarId = barId + '-over-inner';

            if (widthPercentage <= threshold1Percentage) {
                const widthPercentageStr = widthPercentage.toFixed(0) + '%';
                document.querySelector(innerBarId).style.width = widthPercentageStr;
                document.querySelector(innerOverBarId).style.width = "0%";
            } else if (widthPercentage <= 100) {
                const widthPercentageStr = threshold1Percentage.toFixed(0) + '%';
                document.querySelector(innerBarId).style.width = widthPercentageStr;
                const widthPercentageOverStr = (widthPercentage - threshold1Percentage).toFixed(0) + '%';
                document.querySelector(innerOverBarId).style.width = widthPercentageOverStr;
            }
        }
        if ((threshold1 === undefined) && (threshold2 === undefined)) {
            const widthPercentageStr = widthPercentage.toFixed(0) + '%';
            document.querySelector(innerBarId).style.width = widthPercentageStr;
        }
    }
</script>

<!-- Add a row in the table -->
<script type="text/javascript">
    var rowIsEven = false;

    function addRow(col1innerHtml, col2innerHtml, col3innerHtml, col4innerHtml) {
        let tableBody = document.getElementsByTagName("tbody").item(0);
        let row = document.createElement("tr");
        if (rowIsEven) {
            row.style.backgroundColor = "whitesmoke";
        } else {
            row.style.backgroundColor = "white";
        }
        row.style.fontSize = "smaller";

        let cell1 = document.createElement("td");
        let cell2 = document.createElement("td");
        let cell3 = document.createElement("td");
        let cell4 = document.createElement("td");

        cell1.innerHTML = col1innerHtml;
        cell2.innerHTML = col2innerHtml;
        cell3.innerHTML = col3innerHtml;
        cell4.innerHTML = col4innerHtml;

        row.appendChild(cell1);
        row.appendChild(cell2);
        row.appendChild(cell3);
        row.appendChild(cell4);

        tableBody.appendChild(row);
        rowIsEven = !rowIsEven;
    }
</script>

<!-- Registers reading in loop -->
<script type="text/javascript">
    const CYCLE_MAX_NUMBER = 10;
    var cycleNumber = 0;

    const PRIORITY_DIVISOR_HIGH = 1;
    const PRIORITY_DIVISOR_MID = 5;
    const PRIORITY_DIVISOR_LOW = 10;

    const readSpinnersList = document.querySelectorAll(".reading-process-spinner");
    function spinnnersOn() {
        readSpinnersList.forEach((spinner) => {
            spinner.classList.remove("spinner-invisible");
        });
    }

    function spinnersOff() {
        readSpinnersList.forEach((spinner) => {
            spinner.classList.add("spinner-invisible");
        });
    }

    const mapRegisters = new Map();
    async function batchRegistersRead() {
        if (cycleNumber % PRIORITY_DIVISOR_HIGH == 0) {
            spinnnersOn();
            const regs100_132 = await rawReadRegs(100, 33);
            if (regs100_132.ok) {
                for (i = 0; i < 33; i++) {
                    mapRegisters.set(100 + i, regs100_132.ok[i]);
                }
            } else {
                for (i = 0; i < 33; i++) {
                    mapRegisters.set(100 + i, undefined);
                }
            }

            const regsPower = await rawReadRegs(135, 3);
            if (regsPower.ok) {
                mapRegisters.set(135, regsPower.ok[0]);
                mapRegisters.set(137, regsPower.ok[1]);
                mapRegisters.set(139, regsPower.ok[2]);
            } else {
                mapRegisters.set(135, undefined);
                mapRegisters.set(137, undefined);
                mapRegisters.set(139, undefined);
            }
            spinnersOff();

            const regs150_153 = await rawReadRegs(150, 4);
            if (regs150_153.ok) {
                mapRegisters.set(150, regs150_153.ok[0]);
                mapRegisters.set(151, regs150_153.ok[1]);
                mapRegisters.set(152, regs150_153.ok[2]);
                mapRegisters.set(153, regs150_153.ok[3]);
            } else {
                mapRegisters.set(150, undefined);
                mapRegisters.set(151, undefined);
                mapRegisters.set(152, undefined);
                mapRegisters.set(153, undefined);
            }

            const reg177 = await rawReadRegs(177, 1);
            if (reg177.ok) {
                mapRegisters.set(177, reg177.ok[0]);
            } else {
                mapRegisters.set(177, undefined);
            }

            const reg180 = await rawReadRegs(180, 1);
            if (reg180.ok) {
                mapRegisters.set(180, reg180.ok[0]);
            } else {
                mapRegisters.set(180, undefined);
            }
        }

        if (cycleNumber % PRIORITY_DIVISOR_LOW == 0) {
            const reg133 = await rawReadRegs(133, 1);
            if (reg133.ok) {
                mapRegisters.set(133, reg133.ok[0]);
            } else {
                mapRegisters.set(133, undefined);
            }

            const reg203 = await rawReadRegs(203, 1);
            if (reg203.ok) {
                mapRegisters.set(203, reg203.ok[0]);
            } else {
                mapRegisters.set(203, undefined);
            }

            const reg205 = await rawReadRegs(205, 1);
            if (reg205.ok) {
                mapRegisters.set(205, reg205.ok[0]);
            } else {
                mapRegisters.set(205, undefined);
            }

            const regs211 = await rawReadRegs(211, 3);
            if (regs211.ok) {
                for (i = 0; i < 3; i++) {
                    mapRegisters.set(211 + i, regs211.ok[i]);
                }
            } else {
                for (i = 0; i < 3; i++) {
                    mapRegisters.set(211 + i, undefined);
                }
            }

            const reg221 = await rawReadRegs(221, 1);
            if (reg221.ok) {
                mapRegisters.set(221, reg221.ok[0]);
            } else {
                mapRegisters.set(221, undefined);
            }

            const reg224 = await rawReadRegs(224, 1);
            if (reg224.ok) {
                mapRegisters.set(224, reg224.ok[0]);
            } else {
                mapRegisters.set(224, undefined);
            }

            const reg228 = await rawReadRegs(228, 1);
            if (reg228.ok) {
                mapRegisters.set(228, reg228.ok[0]);
            } else {
                mapRegisters.set(228, undefined);
            }
        }

        if (cycleNumber % PRIORITY_DIVISOR_MID == 0) {
            const regsModeAlarms = await rawReadRegs(240, 3);
            if (regsModeAlarms.ok) {
                mapRegisters.set(240, regsModeAlarms.ok[0]);
                mapRegisters.set(241, regsModeAlarms.ok[1]);
                mapRegisters.set(242, regsModeAlarms.ok[2]);
            } else {
                mapRegisters.set(240, undefined);
                mapRegisters.set(241, undefined);
                mapRegisters.set(242, undefined);
            }
        }

        cycleNumber = (cycleNumber + 1) % CYCLE_MAX_NUMBER;
    }
</script>

<!-- Fault processing -->
<script type="text/javascript">
    var faultsPrev = Array(ALARM_TYPES_NUMBER).fill(false);
    var faultsCurr = Array(ALARM_TYPES_NUMBER).fill(false);

    async function determineFaults() {
        const FAULT = 1;

        // set of alarms bit located in these two registers:
        let alarmsBits1 = mapRegisters.get(alarms[0].address);
        let alarmsBits2 = mapRegisters.get(alarms[0].address + 1);
        if (alarmsBits1 != undefined && alarmsBits2 != undefined) {
            for (let i = 0; i < 16; i++) {
                faultsCurr[i] = ((alarmsBits1 >>> i) & 1) === FAULT;
            }
            for (let i = 16; i < ALARM_TYPES_NUMBER; i++) {
                faultsCurr[i] = ((alarmsBits2 >>> (i - 16)) & 1) === FAULT;
            }
        }
    }

    function faultsSouldBePrinted(faultsPrev, faultsCurr) /* boolean arrays */ {
        if (faultsPrev.length != faultsCurr.length) {
            console.warn("arrays lengths must be equal!");
            return undefined;
        }

        const shouldBePrinted = Array(faultsCurr.length).fill(false);

        for (let i = 0; i < faultsCurr.length; i++) {
            if ((!faultsPrev[i]) && (faultsCurr[i])) {
                shouldBePrinted[i] = true;
            }
        }

        return shouldBePrinted;
    }
</script>

<!-- Graph -->
<script type="text/javascript">
    class GraphSequencing {
        constructor(capacity) {
            this.idx = 0;
            this.queue = new Array();
            this.capacity = capacity;
        }

        get maxIndex() {
            return this.capacity - 1;
        }

        push(element, colors) {
            while (this.queue.length >= this.capacity) {
                this.queue.shift();
            }
            const timestamp = [new Date().valueOf()];
            this.queue.push({ element, colors, timestamp });
        }

        pushFromHistory(element, timestamp, colors) {
            while (this.queue.length >= this.capacity) {
                this.queue.shift();
            }
            this.queue.push({ element, colors, timestamp });
        }

        turn() {
            if (this.idx < this.capacity) {
                this.idx++;
            } else {
                this.idx = 0;
            }
        }
    }

    class Graph {
        constructor(capacity, selector, graphsNumber) {
            this.sequencing = new GraphSequencing(capacity);

            this.chart = new Chart(document.querySelector(selector).getContext("2d"), {
                data: {
                    datasets: new Array(graphsNumber).fill().map(function () {
                        return {
                            type: "scatter",
                            data: new Array(capacity).fill({ x: undefined, y: undefined }),
                            backgroundColor: "grey",
                            borderColor: "rgba(128, 128, 128, 0.5)",
                        }
                    }),
                },
                options: {
                    animation: false,
                    showLine: true,
                    scales: {
                        x: {
                            ticks: {
                                callback: function (value, index, ticks) {
                                    return value + 's';
                                },
                            },
                            reverse: true,
                            min: 0,
                            max: 0,
                        }
                    }
                }
            });

            this.minutesScale = false;

            this.debug = false;
        }

        setMaxX(value) {
            this.chart.options.scales.x.max = value;
            this.chart.update();
        }

        setDataLabels(labels) {
            for (let i = 0; i < labels.length; i++) {
                this.chart.data.datasets[i].label = labels[i];
            }
            this.chart.update();
        }

        setDatachartType(datasetIndex, typestr) {
            this.chart.data.datasets[datasetIndex].type = typestr;
            this.chart.update();
        }

        setColors(colors) {
            for (let i = 0; i < colors.length; i++) {
                this.chart.data.datasets[i].backgroundColor = colors[i];
                this.chart.data.datasets[i].borderColor = colors[i];
            }
            this.chart.update();
        }

        setMinutesScale() {
            this.minutesScale = true;
            this.chart.options.scales.x.ticks.callback = function (value, index, ticks) {
                return value + 'm';
            };
            this.chart.update();
        }

        addPoint(values) {
            this.sequencing.push(values, undefined);

            let data = this.sequencing.queue;
            const datasetsNumber = values.length;
            const now = new Date().valueOf();

            for (let i = 0; i < data.length; i++) {
                for (let ds = 0; ds < datasetsNumber; ds++) {
                    if (this.minutesScale == true) {
                        this.chart.data.datasets[ds].data[this.sequencing.maxIndex - i] = {
                            x: (now - data[i].timestamp[0]) / 60000,
                            y: data[i].element[ds],
                        };
                    } else {
                        this.chart.data.datasets[ds].data[this.sequencing.maxIndex - i] = {
                            x: (now - data[i].timestamp[0]) / 1000,
                            y: data[i].element[ds],
                        };
                    }
                }
            }

            this.chart.update();
            this.sequencing.turn();
        }

        addFromHistory(values, timestamp) {
            this.sequencing.pushFromHistory(values, timestamp, undefined);

            let data = this.sequencing.queue;
            const datasetsNumber = values.length;
            const now = new Date().valueOf();

            for (let i = 0; i < data.length; i++) {
                for (let ds = 0; ds < datasetsNumber; ds++) {
                    if (this.minutesScale == true) {
                        this.chart.data.datasets[ds].data[this.sequencing.maxIndex - i] = {
                            x: (now - data[i].timestamp[ds]) / 60000,
                            y: data[i].element[ds],
                        };
                    } else {
                        this.chart.data.datasets[ds].data[this.sequencing.maxIndex - i] = {
                            x: (now - data[i].timestamp[ds]) / 1000,
                            y: data[i].element[ds],
                        };
                    }
                }
            }

            this.chart.update();
            this.sequencing.turn();
        }
    }

    /***********/
    /* Thermal */
    /***********/

    var tempGraph = new Graph(30, "#heating-graph", 3);
    tempGraph.setDataLabels(["Temperature, % of max", "66%", "100%"]);
    tempGraph.setColors(["grey", "rgba(50, 50, 200, 1)", "rgba(200, 50, 50, 1)"]);
    tempGraph.setDatachartType(1, "line");
    tempGraph.setDatachartType(2, "line");

    /************/
    /* Voltages */
    /************/

    var voltGraph = new Graph(20, "#voltage-phases-graph", 3);
    voltGraph.setDataLabels(["Voltage phase 1", "Voltage phase 2", "Voltage phase 3"]);
    voltGraph.setMaxX(100);
    voltGraph.setColors(["yellowgreen", "limegreen", "forestgreen"]);

    var voltGraphM = new Graph(1000, "#voltage-phases-graph-m", 3);
    voltGraphM.setDataLabels(["Voltage phase 1", "Voltage phase 2", "Voltage phase 3"]);
    voltGraphM.setMaxX(20);
    voltGraphM.setColors(["yellowgreen", "limegreen", "forestgreen"]);
    voltGraphM.setMinutesScale();

    /****************/
    /* Currents RMS */
    /****************/

    var ampGraph = new Graph(20, "#amperage-phases-graph", 3);
    ampGraph.setDataLabels(["Current RMS phase 1", "Current RMS phase 2", "Current RMS phase 3"]);
    ampGraph.setMaxX(100);
    ampGraph.setColors(["orange", "gold", "goldenrod"]);

    var ampGraphM = new Graph(1000, "#amperage-phases-graph-m", 3);
    ampGraphM.setDataLabels(["Current RMS phase 1", "Current RMS phase 2", "Current RMS phase 3"]);
    ampGraphM.setMaxX(20);
    ampGraphM.setColors(["orange", "gold", "goldenrod"]);
    ampGraphM.setMinutesScale();
</script>

<!-- Indicators -->
<script type="text/javascript">
    async function processUbzStatuses() {
        const mmspMode = mapRegisters.get(102);

        const LOAD_RELAY_BIT = 1;
        const FUNCTIONAL_RELAY_BIT = 2;
        const CLOSED = 1;

        if (mmspMode != undefined) {
            if (mmspMode == 1) {
                document.querySelector("#mmsp-mode").classList.add("btn-pulse");
            }
        }
        else {
            document.querySelector("#mmsp-mode").classList.remove("btn-pulse");
        }

        const bitsValue = mapRegisters.get(240);

        if (extractBitValue(bitsValue, FUNCTIONAL_RELAY_BIT) == CLOSED) {
            document.querySelector("#functional-relay-mode").classList.add("btn-pulse");
        } else {
            document.querySelector("#functional-relay-mode").classList.remove("btn-pulse");
        }

        if (extractBitValue(bitsValue, LOAD_RELAY_BIT) == CLOSED) {
            document.querySelector("#motor-relay-mode").classList.add("btn-pulse");
        } else {
            document.querySelector("#motor-relay-mode").classList.remove("btn-pulse");
        }
    }

    var motorStartedManually = false;

    const COMMAND_REGISTER = 237;
    const MOTOR_STOP_MANUALLY = [0];
    const MOTOR_START_MANUALLY = [2];
    const RESET_FAULT = [55];

    async function startStopMotor() {
        if (!motorStartedManually) {
            await writeRegValues(COMMAND_REGISTER, MOTOR_START_MANUALLY);
            document.querySelector("#motor-start-stop-button").innerHTML = "Stop";
            motorStartedManually = true;
        } else {
            await writeRegValues(COMMAND_REGISTER, MOTOR_STOP_MANUALLY);
            document.querySelector("#motor-start-stop-button").innerHTML = "Start";
            motorStartedManually = false;
        }
    }

    async function processArIndicator() {
        const ALLOW_REMOTE = 2;

        if (mapRegisters.get(203) == ALLOW_REMOTE) {
            document.querySelector("#ar-indicator").classList.add("btn-pulse");
        } else {
            document.querySelector("#ar-indicator").classList.remove("btn-pulse");
        }
    }

    async function processRcIndicator() {
        const PROHIBITED = 0;

        if (mapRegisters.get(221) != PROHIBITED && mapRegisters.get(221) != undefined) {
            document.querySelector("#rc-indicator").classList.add("btn-pulse");
            document.querySelector("#motor-start-stop-button").innerHTML = "Start";
            document.querySelector("#motor-start-stop-button").disabled = false;
            document.querySelector("#motor-start-stop-button").addEventListener("click", startStopMotor);
        } else {
            document.querySelector("#rc-indicator").classList.remove("btn-pulse");
            document.querySelector("#motor-start-stop-button").innerHTML = "Automatic mode";
            document.querySelector("#motor-start-stop-button").disabled = true;
            document.querySelector("#motor-start-stop-button").removeEventListener("click", startStopMotor);
        }
    }

    async function processExternalInputIndicator() {
        const INDICATOR_LIT = "orange";
        const INDICATOR_DIM = "darkgoldenrod";

        if (mapRegisters.get(224) == undefined || mapRegisters.get(228) == undefined) {
            document.querySelector("#ext-in-indicator").classList.remove("btn-pulse");
        } else if (mapRegisters.get(224) != 0 && mapRegisters.get(228) != 0) {
            document.querySelector("#ext-in-indicator").classList.add("btn-pulse");
        } else {
            document.querySelector("#ext-in-indicator").classList.remove("btn-pulse");
        }
    }

    function processFaultIndicator(isFault) {
        if (isFault) {
            document.querySelector("#fault-indicator").classList.add("btn-pulse");
        } else {
            document.querySelector("#fault-indicator").classList.remove("btn-pulse");
        }
    }
</script>

<!-- Selection listeners -->
<script type="text/javascript">
    async function stringPowerCharacteristicByKey(keystring) {
        var outstring = "Unknown";
        switch (keystring) {
            case "phase-1-full-power":
                {
                    const RMSVoltagePhase1 = mapRegisters.get(114);
                    const RMSCurrentPhase1 = mapRegisters.get(100);
                    if (RMSVoltagePhase1 != undefined && RMSCurrentPhase1 != undefined) {
                        const phase1FullPower = RMSVoltagePhase1 * RMSCurrentPhase1 * 0.1;
                        outstring = phase1FullPower.toString();
                    }
                }
                break;
            case "phase-2-full-power":
                {
                    const RMSVoltagePhase2 = mapRegisters.get(115);
                    const RMSCurrentPhase2 = mapRegisters.get(101);
                    if (RMSVoltagePhase2 != undefined && RMSCurrentPhase2 != undefined) {
                        const phase2FullPower = RMSVoltagePhase2 * RMSCurrentPhase2 * 0.1;
                        outstring = phase2FullPower.toString();
                    }
                }
                break;
            case "phase-3-full-power":
                {
                    const RMSVoltagePhase3 = mapRegisters.get(116);
                    const RMSCurrentPhase3 = mapRegisters.get(102);
                    if (RMSVoltagePhase3 != undefined && RMSCurrentPhase3 != undefined) {
                        const phase3FullPower = RMSVoltagePhase3 * RMSCurrentPhase3 * 0.1;
                        outstring = phase3FullPower.toString();
                    }
                }
                break;
            case "phase-1-active-power":
                {
                    const RMSVoltagePhase1 = mapRegisters.get(114);
                    const RMSCurrentPhase1 = mapRegisters.get(100);
                    const cosPhiPhase1 = await rawReadRegs(141, 1);
                    if (RMSVoltagePhase1 != undefined && RMSCurrentPhase1 != undefined && cosPhiPhase1.ok) {
                        const phase1activePower = RMSVoltagePhase1 * RMSCurrentPhase1 * 0.1 * cosPhiPhase1.ok[0] * 0.001;
                        outstring = phase1activePower.toString();
                    }
                }
                break;
            case "phase-2-active-power":
                {
                    const RMSVoltagePhase2 = mapRegisters.get(115);
                    const RMSCurrentPhase2 = mapRegisters.get(101);
                    const cosPhiPhase2 = await rawReadRegs(143, 1);
                    if (RMSVoltagePhase2 != undefined && RMSCurrentPhase2 != undefined && cosPhiPhase2.ok) {
                        const phase2activePower = RMSVoltagePhase2 * RMSCurrentPhase2 * 0.1 * cosPhiPhase2.ok[0] * 0.001;
                        outstring = phase2activePower.toString();
                    }
                }
                break;
            case "phase-3-active-power":
                {
                    const RMSVoltagePhase3 = mapRegisters.get(116);
                    const RMSCurrentPhase3 = mapRegisters.get(102);
                    const cosPhiPhase3 = await rawReadRegs(145, 1);
                    if (RMSVoltagePhase3 != undefined && RMSCurrentPhase3 != undefined && cosPhiPhase3.ok) {
                        const phase3activePower = RMSVoltagePhase3 * RMSCurrentPhase3 * 0.1 * cosPhiPhase3.ok[0] * 0.001;
                        outstring = phase3activePower.toString();
                    }
                }
                break;
            case "phase-1-reactive-power":
                {
                    const RMSVoltagePhase1 = mapRegisters.get(114);
                    const RMSCurrentPhase1 = mapRegisters.get(100);
                    const cosPhiPhase1 = await rawReadRegs(141, 1);
                    if (RMSVoltagePhase1 != undefined && RMSCurrentPhase1 != undefined && cosPhiPhase1.ok) {
                        const sinPhiPhase1 = sinFromCos(cosPhiPhase1.ok[0] * 0.001);
                        const phase1reactivePower = RMSVoltagePhase1 * RMSCurrentPhase1 * 0.1 * sinPhiPhase1;
                        outstring = phase1reactivePower.toString();
                    }
                }
                break;
            case "phase-2-reactive-power":
                {
                    const RMSVoltagePhase2 = mapRegisters.get(115);
                    const RMSCurrentPhase2 = mapRegisters.get(101);
                    const cosPhiPhase2 = await rawReadRegs(143, 1);
                    if (RMSVoltagePhase2 != undefined && RMSCurrentPhase2 != undefined && cosPhiPhase2.ok) {
                        const sinPhiPhase2 = sinFromCos(cosPhiPhase2.ok[0] * 0.001);
                        const phase2reactivePower = RMSVoltagePhase2 * RMSCurrentPhase2 * 0.1 * sinPhiPhase2;
                        outstring = phase2reactivePower.toString();
                    }
                }
                break;
            case "phase-3-reactive-power":
                {
                    const RMSVoltagePhase3 = mapRegisters.get(116);
                    const RMSCurrentPhase3 = mapRegisters.get(102);
                    const cosPhiPhase3 = await rawReadRegs(145, 1);
                    if (RMSVoltagePhase3 != undefined && RMSCurrentPhase3 != undefined && cosPhiPhase3.ok) {
                        const sinPhiPhase3 = sinFromCos(cosPhiPhase3.ok[0] * 0.001);
                        const phase3reactivePower = RMSVoltagePhase3 * RMSCurrentPhase3 * 0.1 * sinPhiPhase3;
                        outstring = phase3reactivePower.toString();
                    }
                }
                break;
            case "phase-1-cos-phi":
                {
                    const cosPhiPhase1Raw = await rawReadRegs(141, 1);
                    if (cosPhiPhase1Raw.ok) {
                        const cosPhiPhase1 = cosPhiPhase1Raw.ok[0] * 0.001;
                        outstring = cosPhiPhase1.toFixed(3);
                    }
                }
                break;
            case "phase-2-cos-phi":
                {
                    const cosPhiPhase2Raw = await rawReadRegs(143, 1);
                    if (cosPhiPhase2Raw.ok) {
                        const cosPhiPhase2 = cosPhiPhase2Raw.ok[0] * 0.001;
                        outstring = cosPhiPhase2.toFixed(3);
                    }
                }
                break;
            case "phase-3-cos-phi":
                {
                    const cosPhiPhase3Raw = await rawReadRegs(145, 1);
                    if (cosPhiPhase3Raw.ok) {
                        const cosPhiPhase3 = cosPhiPhase3Raw.ok[0] * 0.001;
                        outstring = cosPhiPhase3.toFixed(3);
                    }
                }
                break;
            case "no-selection":
                outstring = "";
                break;
        }
        return outstring;
    }
</script>

<!-- Event listeners -->
<script type="text/javascript">
    // TODO: affect only when changed
    document.querySelector("#radio-workmode-alarm").addEventListener("click", async function () {
        await writeRegValues(205, [0]);
    });

    document.querySelector("#radio-workmode-time").addEventListener("click", async function () {
        await writeRegValues(205, [1]);
    });

    document.querySelector("#radio-workmode-stardelta").addEventListener("click", async function () {
        await writeRegValues(205, [2]);
    });

    document.querySelector("#reset-fault-button").addEventListener("click", async function () {
        document.querySelector("#reset-fault-button-spinner").classList.remove("spinner-invisible");
        await writeRegValues(COMMAND_REGISTER, RESET_FAULT);
        document.querySelector("#reset-fault-button-spinner").classList.add("spinner-invisible");
    });

    document.querySelector("#power-characteristic-value-1").addEventListener("change", async function () {
        const characteristicString = await stringPowerCharacteristicByKey(document.querySelector("#power-characteristic-value-1").value);
        document.querySelector("#power-show-value-1").innerHTML = characteristicString;
    });

    document.querySelector("#power-characteristic-value-2").addEventListener("change", async function () {
        const characteristicString = await stringPowerCharacteristicByKey(document.querySelector("#power-characteristic-value-2").value);
        document.querySelector("#power-show-value-2").innerHTML = characteristicString;
    });

    document.querySelector("#power-characteristic-value-3").addEventListener("change", async function () {
        const characteristicString = await stringPowerCharacteristicByKey(document.querySelector("#power-characteristic-value-3").value);
        document.querySelector("#power-show-value-3").innerHTML = characteristicString;
    });

    document.querySelector("#save-file-button").addEventListener("click", async function () {
        document.querySelector("#save-file-button-spinner").classList.remove("spinner-invisible");
        const now = new Date();
        const promiseTimeout = new Promise((resolve, reject) => {
            setTimeout(() => "", 10000);
        });
        const url = await createReportURL();
        if (url.length == 0) {
            console.log("No response for report");
        } else {
            const hiddenEl = document.createElement("a");
            hiddenEl.href = url;
            hiddenEl.target = "_blank";
            hiddenEl.download = "UBZ faults " + now.toUTCString() + ".html";
            hiddenEl.click();
            delete (hiddenEl);
        }

        document.querySelector("#save-file-button-spinner").classList.add("spinner-invisible");
    });

    document.querySelector("#CT-in-use").addEventListener("change", async function () {
        if (document.querySelector("#CT-in-use").value == "integrated-CT") {
            const res = await writeRegValues(150, [0]);
        } else if (document.querySelector("#CT-in-use").value == "external-CT") {
            const res = await writeRegValues(150, [1]);
        }
    });

    document.querySelector("#external-ct-current").addEventListener("change", async function () {
        await writeRegValues(151, [document.querySelector("#external-ct-current").value]);
    });

    document.querySelector("#motor-rated-current").addEventListener("change", async function () {
        await writeRegValues(152, [document.querySelector("#motor-rated-current").value]);
    });

    switchableGraphsByCheckbox("#minutes-voltage-graph", "#div-voltage-phases-graph", "#div-voltage-phases-graph-m");
    switchableGraphsByCheckbox("#minutes-amperage-graph", "#div-amperage-phases-graph", "#div-amperage-phases-graph-m");

    document.querySelector("#ubz-parameters-button").addEventListener("click", function () {
        document.querySelector("#substarat-popup-menu").style.display = 'block'
        document.querySelector("#ubz-parameters-menu").style.display = 'block';
    });

    document.querySelector("#ubz-parameters-close").addEventListener("click", function () {
        document.querySelector("#substarat-popup-menu").style.display = 'none'
        document.querySelector("#ubz-parameters-menu").style.display = 'none';
    });

    var ubzParamsChanged = new Array(81).fill(false);

    for (let i = 150; i <= 230; i++) {
        document.querySelector("#ubz-param-input-" + i.toString()).addEventListener("change", function () {
            ubzParamsChanged[i - 150] = true;
        });
    }

    document.querySelector("#button-write-ubz-params").addEventListener("click", async function () {
        if (document.querySelector("#checkbox-write-only-modified-ubz-params").checked) {
            for (let i = 150; i <= 230; i++) {
                if (ubzParamsChanged[i - 150]) {
                    await writeRegValues(i, [document.querySelector("#ubz-param-input-" + i.toString()).value]);
                }
            }
        } else {
            let values = new Array();
            for (let i = 150; i <= 230; i++) {
                values.push(document.querySelector("#ubz-param-input-" + i.toString()).value);
            }
            await writeRegValues(150, values);
        }

        ubzParamsChanged.fill(false);
    });

    document.querySelector("#button-read-ubz-params").addEventListener("click", async function () {
        const ubzParams = await rawReadRegs(150, 81); // registers 150-230

        if (ubzParams.ok) {
            for (let i = 150; i <= 230; i++) {
                document.querySelector("#ubz-param-input-" + i.toString()).value = ubzParams.ok[i - 150];
            }
        }
    });
</script>

<script type="text/javascript">
    const PHASE_VOLTAGE_THRESHOLD = 220;
    const UPDATE_VISUALIZATION_INTERVAL_MS = 1000;
    const dateTimeStart = new Date();
    var deviceConnected = false;
    var faultIndicatorSet = false;
    var loopLock = false;

    async function initElements() {
        const ubzParams = await rawReadRegs(150, 81); // registers 150-230

        const volt1History = await readRegFromDb(114);
        const volt2History = await readRegFromDb(115);
        const volt3History = await readRegFromDb(116);
        const voltHistoryLength = Math.max(volt1History.length, volt2History.length, volt3History.length);

        const amp1History = await readRegFromDb(100);
        const amp2History = await readRegFromDb(101);
        const amp3History = await readRegFromDb(102);
        const ampHistoryLength = Math.max(amp1History.length, amp2History.length, amp3History.length);

        for (let i = voltHistoryLength - 1; i >= 0; i--) {
            const volt1 = volt1History[i][1];
            const volt2 = volt2History[i][1];
            const volt3 = volt3History[i][1];
            const t1 = new Date(volt1History[i][0]).valueOf();
            const t2 = new Date(volt2History[i][0]).valueOf();
            const t3 = new Date(volt3History[i][0]).valueOf();
            voltGraphM.addFromHistory([volt1, volt2, volt3], [t1, t2, t3]);
        }

        for (let i = ampHistoryLength - 1; i >= 0; i--) {
            const amp1 = amp1History[i][1];
            const amp2 = amp2History[i][1];
            const amp3 = amp3History[i][1];
            const t1 = new Date(amp1History[i][0]).valueOf();
            const t2 = new Date(amp2History[i][0]).valueOf();
            const t3 = new Date(amp3History[i][0]).valueOf();
            ampGraphM.addFromHistory([amp1, amp2, amp3], [t1, t2, t3]);
        }

        if (ubzParams.ok) {
            for (let i = 150; i <= 230; i++) {
                document.querySelector("#ubz-param-input-" + i.toString()).value = ubzParams.ok[i - 150];
            }

            if (ubzParams.ok[0] == 0) {
                document.querySelector("#CT-in-use").children[0].setAttribute("selected", "true");
                deactivateExternalCTsettings();
            }
            if (ubzParams.ok[0] == 1) {
                document.querySelector("#CT-in-use").children[1].setAttribute("selected", "true");
                activateExternalCTsettings();
            }

            document.querySelector("#external-ct-current").value = ubzParams.ok[1];
            document.querySelector("#motor-rated-current").value = ubzParams.ok[2];
        }

        {
            const characteristicString = await stringPowerCharacteristicByKey(document.querySelector("#power-characteristic-value-1").value);
            document.querySelector("#power-show-value-1").innerHTML = characteristicString;
        }
        {
            const characteristicString = await stringPowerCharacteristicByKey(document.querySelector("#power-characteristic-value-2").value);
            document.querySelector("#power-show-value-2").innerHTML = characteristicString;
        }
        {
            const characteristicString = await stringPowerCharacteristicByKey(document.querySelector("#power-characteristic-value-3").value);
            document.querySelector("#power-show-value-3").innerHTML = characteristicString;
        }
    }

    const FAULT_BIT = 0;
    const FAULT = 1;

    async function updateValuesOnVis() {
        let currentDateTime = new Date();
        let sessionTimeString = timeStringFromMillis((currentDateTime - dateTimeStart));
        document.querySelector("#session-time").innerHTML = "Session time: " + sessionTimeString;

        if (loopLock) {
            return;
        } else {
            loopLock = true;
        }

        await batchRegistersRead();
        await processUbzStatuses();
        await processArIndicator();
        await processRcIndicator();
        await processExternalInputIndicator();

        let isFault = extractBitValue(mapRegisters.get(240), FAULT_BIT) == FAULT;
        if (isFault) {
            processFaultIndicator(isFault);

            await determineFaults();

            let faultsToPrint = faultsSouldBePrinted(faultsPrev, faultsCurr);
            for (let i = 0; i < faultsCurr.length; i++) {
                if (faultsToPrint[i]) {
                    let time = timeString(currentDateTime);

                    const fault = alarms[i];
                    if (fault.valueAddress === undefined) {
                        addRow(fault.name, fault.mnemonic, "", time);
                    } else {
                        let valueRaw = await rawReadRegs(fault.valueAddress, 1);
                        addRow(fault.name, fault.mnemonic, valueRaw.ok[0].toString(), time);
                    }
                }
            }

            faultsPrev = faultsCurr;
        }

        if (mapRegisters.get(100) != undefined) {
            document.querySelector("#phase-1-current-rms-value").innerHTML = (mapRegisters.get(100) * 0.1).toFixed(1);
            document.querySelector("#phase-1-current-rms-bar").value = mapRegisters.get(100);
        } else {
            document.querySelector("#phase-1-current-rms-value").innerHTML = "Err";
            document.querySelector("#phase-1-current-rms-bar").value = 0;
        }

        if (mapRegisters.get(101) != undefined) {
            document.querySelector("#phase-2-current-rms-value").innerHTML = (mapRegisters.get(101) * 0.1).toFixed(1);
            document.querySelector("#phase-2-current-rms-bar").value = mapRegisters.get(101);
        } else {
            document.querySelector("#phase-2-current-rms-value").innerHTML = "Err";
            document.querySelector("#phase-2-current-rms-bar").value = 0;
        }

        if (mapRegisters.get(102) != undefined) {
            document.querySelector("#phase-3-current-rms-value").innerHTML = (mapRegisters.get(102) * 0.1).toFixed(1);
            document.querySelector("#phase-3-current-rms-bar").value = mapRegisters.get(102);
        } else {
            document.querySelector("#phase-3-current-rms-value").innerHTML = "Err";
            document.querySelector("#phase-3-current-rms-bar").value = 0;
        }

        ampGraph.addPoint([mapRegisters.get(100), mapRegisters.get(101), mapRegisters.get(102)]);
        ampGraphM.addPoint([mapRegisters.get(100), mapRegisters.get(101), mapRegisters.get(102)]);

        if (mapRegisters.get(103) != undefined) {
            document.querySelector("#zero-sequence-current-value").innerHTML = (mapRegisters.get(103) * 0.1).toFixed(1);
            document.querySelector("#zero-sequence-current-bar").value = mapRegisters.get(103);
        } else {
            document.querySelector("#zero-sequence-current-value").innerHTML = "Err";
            document.querySelector("#zero-sequence-current-bar").value = 0;
        }
        barValue("#zero-sequence-current-bar", 50);
        if (mapRegisters.get(104) != undefined) {
            document.querySelector("#avg-current-value-phase-1").innerHTML = (mapRegisters.get(104) * 0.1).toFixed(1);
        } else {
            document.querySelector("#avg-current-value-phase-1").innerHTML = "Err";
        }
        if (mapRegisters.get(105) != undefined) {
            document.querySelector("#avg-current-value-phase-2").innerHTML = (mapRegisters.get(105) * 0.1).toFixed(1);
        } else {
            document.querySelector("#avg-current-value-phase-2").innerHTML = "Err";
        }
        if (mapRegisters.get(106) != undefined) {
            document.querySelector("#avg-current-value-phase-3").innerHTML = (mapRegisters.get(106) * 0.1).toFixed(1);
        } else {
            document.querySelector("#avg-current-value-phase-3").innerHTML = "Err";
        }
        if (mapRegisters.get(107) != undefined) {
            document.querySelector("#max-current-value-phase-1").innerHTML = (mapRegisters.get(107) * 0.1).toFixed(1);
        } else {
            document.querySelector("#max-current-value-phase-1").innerHTML = "Err";
        }
        if (mapRegisters.get(108) != undefined) {
            document.querySelector("#max-current-value-phase-2").innerHTML = (mapRegisters.get(108) * 0.1).toFixed(1);
        } else {
            document.querySelector("#max-current-value-phase-2").innerHTML = "Err";
        }
        if (mapRegisters.get(109) != undefined) {
            document.querySelector("#max-current-value-phase-3").innerHTML = (mapRegisters.get(109) * 0.1).toFixed(1);
        } else {
            document.querySelector("#max-current-value-phase-3").innerHTML = "Err";
        }

        if (mapRegisters.get(110) != undefined && mapRegisters.get(100) != 0) {
            document.querySelector("#motor-start-current-value").innerHTML = (mapRegisters.get(110) * 0.1).toFixed(1);
        } else {
            document.querySelector("#motor-start-current-value").innerHTML = "Err";
        }
        if (mapRegisters.get(111) != undefined) {
            document.querySelector("#startup-time-value").innerHTML = mapRegisters.get(111);
        } else {
            document.querySelector("#startup-time-value").innerHTML = "Err";
        }
        if (mapRegisters.get(112) != undefined) {
            document.querySelector("#overload-current-value").innerHTML = (mapRegisters.get(112) * 0.1).toFixed(1);
        } else {
            document.querySelector("#overload-current-value").innerHTML = "Err";
        }
        if (mapRegisters.get(113) != undefined) {
            document.querySelector("#negative-sequence-current-value").innerHTML = (mapRegisters.get(113) * 0.1).toFixed(1);
            document.querySelector("#negative-sequence-current-bar").value = mapRegisters.get(113);
        } else {
            document.querySelector("#negative-sequence-current-value").innerHTML = "Err";
            document.querySelector("#negative-sequence-current-bar").value = 0;
        }
        barValue("#negative-sequence-current-bar", 2000);

        if (mapRegisters.get(114) != undefined) {
            document.querySelector("#phase-1-voltage-value").innerHTML = mapRegisters.get(114);
            document.querySelector("#phase-1-voltage-bar").value = mapRegisters.get(114);
        } else {
            document.querySelector("#phase-1-voltage-value").innerHTML = "Err";
            document.querySelector("#phase-1-voltage-bar").value = 0;
        }
        barValue("#phase-1-voltage-bar", 300, PHASE_VOLTAGE_THRESHOLD);

        if (mapRegisters.get(115) != undefined) {
            document.querySelector("#phase-2-voltage-value").innerHTML = mapRegisters.get(115);
            document.querySelector("#phase-2-voltage-bar").value = mapRegisters.get(115);
        } else {
            document.querySelector("#phase-2-voltage-value").innerHTML = "Err";
            document.querySelector("#phase-2-voltage-bar").value = 0;
        }
        barValue("#phase-2-voltage-bar", 300, PHASE_VOLTAGE_THRESHOLD);

        if (mapRegisters.get(116) != undefined) {
            document.querySelector("#phase-3-voltage-value").innerHTML = mapRegisters.get(116);
            document.querySelector("#phase-3-voltage-bar").value = mapRegisters.get(116);
        } else {
            document.querySelector("#phase-3-voltage-value").innerHTML = "Err";
            document.querySelector("#phase-3-voltage-bar").value = 0;
        }
        barValue("#phase-3-voltage-bar", 300, PHASE_VOLTAGE_THRESHOLD);

        voltGraph.addPoint([mapRegisters.get(114), mapRegisters.get(115), mapRegisters.get(116)]);
        voltGraphM.addPoint([mapRegisters.get(114), mapRegisters.get(115), mapRegisters.get(116)]);

        if (mapRegisters.get(117) != undefined) {
            document.querySelector("#line-1-voltage-value").innerHTML = mapRegisters.get(117);
            document.querySelector("#line-1-voltage-bar").value = mapRegisters.get(117);
        } else {
            document.querySelector("#line-1-voltage-value").innerHTML = "Err";
            document.querySelector("#line-1-voltage-bar").value = 0;
        }
        if (mapRegisters.get(118) != undefined) {
            document.querySelector("#line-2-voltage-value").innerHTML = mapRegisters.get(118);
            document.querySelector("#line-2-voltage-bar").value = mapRegisters.get(118);
        } else {
            document.querySelector("#line-2-voltage-value").innerHTML = "Err";
            document.querySelector("#line-2-voltage-bar").value = 0;
        }
        if (mapRegisters.get(119) != undefined) {
            document.querySelector("#line-3-voltage-value").innerHTML = mapRegisters.get(119);
            document.querySelector("#line-3-voltage-bar").value = mapRegisters.get(119);
        } else {
            document.querySelector("#line-3-voltage-value").innerHTML = "Err";
            document.querySelector("#line-3-voltage-bar").value = 0;
        }

        if (mapRegisters.get(150) != undefined) {
            if (mapRegisters.get(150) == 0) {
                document.querySelector("#CT-in-use").children[0].setAttribute("selected", "true");
                deactivateExternalCTsettings();
            }
            if (mapRegisters.get(150) == 1) {
                document.querySelector("#CT-in-use").children[1].setAttribute("selected", "true");
                activateExternalCTsettings();
            }
        }

        if (mapRegisters.get(151) != undefined) {
            document.querySelector("#external-ct-current").value = mapRegisters.get(151);
        }

        if (mapRegisters.get(152) != undefined) {
            document.querySelector("#motor-rated-current").value = mapRegisters.get(152);
        }

        if (mapRegisters.get(153) != undefined) {
            document.querySelector("#current-average-for-time-value").innerHTML = mapRegisters.get(153);
        } else {
            document.querySelector("#current-average-for-time-value").innerHTML = "Err";
        }

        if (mapRegisters.get(177) != undefined && mapRegisters.get(180) != undefined) {
            barValue("#line-1-voltage-bar", 475, mapRegisters.get(177), mapRegisters.get(180));
            barValue("#line-2-voltage-bar", 475, mapRegisters.get(177), mapRegisters.get(180));
            barValue("#line-3-voltage-bar", 475, mapRegisters.get(177), mapRegisters.get(180));
        }

        if (mapRegisters.get(120) != undefined) {
            document.querySelector("#positive-sequence-voltage-value").innerHTML = mapRegisters.get(120);
        } else {
            document.querySelector("#positive-sequence-voltage-value").innerHTML = "Err";
        }

        if (mapRegisters.get(121) != undefined) {
            document.querySelector("#negative-sequence-voltage-value").innerHTML = mapRegisters.get(121);
            document.querySelector("#negative-sequence-voltage-bar").value = mapRegisters.get(121);
        } else {
            document.querySelector("#negative-sequence-voltage-value").innerHTML = "Err";
            document.querySelector("#negative-sequence-voltage-bar").value = 0;
        }
        barValue("#negative-sequence-voltage-bar", 300);

        if (mapRegisters.get(122) != undefined) {
            document.querySelector("#zero-sequence-voltage-value").innerHTML = mapRegisters.get(122);
        } else {
            document.querySelector("#zero-sequence-voltage-value").innerHTML = "Err";
        }

        if (mapRegisters.get(123) != undefined) {
            document.querySelector("#sensor-1-temperature-value").innerHTML = temperatureSensorReadable(mapRegisters.get(123));
        } else {
            document.querySelector("#sensor-1-temperature-value").innerHTML = "Err";
        }
        if (mapRegisters.get(124) != undefined) {
            document.querySelector("#sensor-2-temperature-value").innerHTML = temperatureSensorReadable(mapRegisters.get(124));
        } else {
            document.querySelector("#sensor-2-temperature-value").innerHTML = "Err";
        }
        if (mapRegisters.get(125) != undefined) {
            document.querySelector("#current-input-value").innerHTML = (mapRegisters.get(125) * 0.01).toFixed(2);
        } else {
            document.querySelector("#current-input-value").innerHTML = "Err";
        }

        if (mapRegisters.get(126) != undefined) {
            document.querySelector("#analog-input-value").innerHTML = (mapRegisters.get(126) * 0.1).toFixed(1);
        } else {
            document.querySelector("#analog-input-value").innerHTML = "Err";
        }

        if (mapRegisters.get(128) != undefined) {
            document.querySelector("#frequency-value").innerHTML = (mapRegisters.get(128) * 0.1).toFixed(1);
        } else {
            document.querySelector("#frequency-value").innerHTML = "Err";
        }

        if (mapRegisters.get(132) != undefined) {
            document.querySelector("#insulation-resistance-value").innerHTML = (mapRegisters.get(132) * 0.1).toFixed(1);
        } else {
            document.querySelector("#insulation-resistance-value").innerHTML = "Err";
        }

        if (mapRegisters.get(130) != undefined) {
            if (mapRegisters.get(130) == 0) {
                document.querySelector("#time-before-ar-string").innerHTML = "Off";
                document.querySelector("#time-before-ar-bar").value = 0;
            } else if (mapRegisters.get(130) > 0 && mapRegisters.get(130) <= 900) {
                document.querySelector("#time-before-ar-string").innerHTML = mapRegisters.get(130).toString();
                document.querySelector("#time-before-ar-bar").value = mapRegisters.get(130);
            } else if (mapRegisters.get(130) == 950) {
                document.querySelector("#time-before-ar-string").innerHTML = "No AR";
                document.querySelector("#time-before-ar-bar").value = 0;
            } else {
                document.querySelector("#time-before-ar-string").innerHTML = "???";
                document.querySelector("#time-before-ar-bar").value = 0;
            }
        } else {
            document.querySelector("#time-before-ar-string").innerHTML = "Err";
            document.querySelector("#time-before-ar-bar").value = 0;
        }
        barValue("#negative-sequence-voltage-bar", 900);

        if (mapRegisters.get(205) != undefined) {
            if (mapRegisters.get(205) == 0) {
                document.querySelector("#radio-workmode-alarm").checked = true;
            } else if (mapRegisters.get(205) == 1) {
                document.querySelector("#radio-workmode-time").checked = true;
            } else if (mapRegisters.get(205) == 2) {
                document.querySelector("#radio-workmode-stardelta").checked = true;
            }
        }

        let heatValue = mapRegisters.get(133);
        if (heatValue != undefined) {
            if (heatValue > 0) {
                document.querySelector("#div-heating-graph").style.display = "block";
            }
            if (document.querySelector("#div-heating-graph").style.display != "none") {
                const heatPercentage = (heatValue / 1100000) * 100;
                let _color = determineHeatgraphColor(heatPercentage);
                tempGraph.addPoint([heatPercentage, 66, 100]);
            }
        } else if (document.querySelector("#div-heating-graph").style.display != "none") {
            tempGraph.addPoint([undefined, 66, 100]);
        }

        if (mapRegisters.get(135) != undefined) {
            document.querySelector("#full-power-value").innerHTML = (mapRegisters.get(135) * 0.01).toString();
        } else {
            document.querySelector("#full-power-value").innerHTML = "Reading error";
        }

        if (mapRegisters.get(137) != undefined) {
            document.querySelector("#active-power-value").innerHTML = (mapRegisters.get(137) * 0.01).toString();
        } else {
            document.querySelector("#active-power-value").innerHTML = "Reading error";
        }

        if (mapRegisters.get(139) != undefined) {
            document.querySelector("#reactive-power-value").innerHTML = (mapRegisters.get(139) * 0.01).toString();
        } else {
            document.querySelector("#reactive-power-value").innerHTML = "Reading error";
        }

        loopLock = false;
    }

    initElements();
    setInterval(updateValuesOnVis, UPDATE_VISUALIZATION_INTERVAL_MS);
</script>