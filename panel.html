<style type="text/css">
    .dashboard-container {
        display: grid;
        grid-template-columns: [col1] auto [col2] auto [col3] auto [col4] auto;
        grid-template-rows: [row1] auto [row2] auto;
        padding: 10px;
        text-align: left;
    }

    .dashboard-item {
        background-color:lightblue;
        margin: 8px;
        padding: 15px;
    }

    .power-characteristic {
        margin: 5px;
    }

    #heating-graph {
        border: 1px solid lightslategrey;
        background-color: white;
    }

    #faults-table {
        border: 1px solid lightslategrey;
    }

    @media only screen and (max-device-width: 1100px) {
        .dashboard-container {
            display: grid;
            grid-template-columns: [col1] auto;
            grid-template-rows: repeat(8, auto [row]);
            padding: 10px;
        }

        .dashboard-item {
            background-color:lightblue;
            margin: 5px;
            padding: 15px;
        }

        .power-characteristic {
            padding: 10px;
        }
    }

    .dashboard-container header {
        text-align: center;
    }
</style>

<div id="ubz-vis-container">
    <alias device="#16" name="ubz"></alias>
    <header>UBZ-302 Control Panel</header>

    <div class="dashboard-container">
        <div class="dashboard-item">
            <header>UBZ Status</header>
            <ul>
                <li>MMSP</li>
                <li>Functional relay</li>
                <li>Motor relay</li>
            </ul>
            <p>Functional relay work mode</p>
            <form id="functional-relay-work-mode-radio">
                <input type="radio" id="radio-workmode-alarm" name="func-relay-workmode" value="alarmrelay">
                <label for="radio-workmode-alarm">Alarm relay</label><br>
                <input type="radio" id="radio-workmode-time" name="func-relay-workmode" value="timerelay">
                <label for="radio-workmode-time">Time relay</label><br>
                <input type="radio" id="radio-workmode-stardelta" name="func-relay-workmode" value="stardelta">
                <label for="radio-workmode-stardelta">Star / delta</label><br>
            </form>
        </div>
        <div class="dashboard-item">
            <div>
                <header>UBZ Fault Status</header>
                <img src="">
                <img src="">
                <img src="">
                <img src="">
                <button>Reset fault</button>
            </div>
            <div>
                <table id="faults-table">
                    <tr>
                        <th>
                            Name
                        </th>
                        <th>
                            ###
                        </th>
                        <th>
                            Value
                        </th>
                        <th>
                            Time
                        </th>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>2</td>
                        <td>3</td>
                        <td>4</td>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>2</td>
                        <td>3</td>
                        <td>4</td>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>2</td>
                        <td>3</td>
                        <td>4</td>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>2</td>
                        <td>3</td>
                        <td>4</td>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>2</td>
                        <td>3</td>
                        <td>4</td>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>2</td>
                        <td>3</td>
                        <td>4</td>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>2</td>
                        <td>3</td>
                        <td>4</td>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>2</td>
                        <td>3</td>
                        <td>4</td>
                    </tr>
                </table>
            </div>
        </div>
        <div class="dashboard-item">
            <header>Heating</header>
            <div>
                <canvas id="heating-graph" width="auto" height="auto"></canvas>
            </div>
        </div>
        <div class="dashboard-item">
            <header>Status of communication with UBZ</header>
            <ul>
                <li>Activity:</li>
                <li>Status: <span id="status-string">Disconnected</span></li>
                <li>Speed: <span id="speed-value">0</span> bps</li>
                <li>Connecting time: <span id="connecting-time-string">00:00:00</span></li>
                <li>Address UBZ: <input type="number" min="1" max="247" value="1" id="modbus-address-ubz" name="modbus-address-ubz"></li>
            </ul>
        </div>
        <div class="dashboard-item">
            <header>Current (Ampere)</header>
                <div>
                    <p>Phase currents active values:</p>
                    <ul>
                        <li>Phase1: <progress id="phase-1-current-rms-bar" value="0" max="6300"></progress> <span id="phase-1-current-rms-value">0.0</span> A</li>
                        <li>Phase2: <progress id="phase-2-current-rms-bar" value="0" max="6300"></progress> <span id="phase-2-current-rms-value">0.0</span> A</li>
                        <li>Phase3: <progress id="phase-3-current-rms-bar" value="0" max="6300"></progress> <span id="phase-3-current-rms-value">0.0</span> A</li>
                    </ul>
                </div>
                <div>
                    <p>Negative sequence current:</p>
                    <progress id="negative-sequence-current-bar" value="0" max="2000"></progress> <span id="negative-sequence-current-value">0.0</span> A
                </div>
                <div>
                    <p>Zero sequence current:</p>
                    <progress id="zero-sequence-current-bar" value="0" max="50"></progress> <span id="zero-sequence-current-value">0.0</span> A
                </div>

                <div>
                    <table>
                        <tr>
                            <th>Current average value:</th>
                            <th>For time</th>
                            <th>Max:</th>
                        </tr>
                        <tr>
                            <td>Phase 1:</td>
                            <td rowspan="3">
                                <span id="current-average-for-time-value">60.0</span> sec
                            </td>
                            <td><span id="avg-current-value-phase-1">0.0</span> A</td>
                        </tr>
                        <tr>
                            <td>Phase 2:</td>
                            <td><span id="avg-current-value-phase-2">0.0</span> A</td>
                        </tr>
                        <tr>
                            <td>Phase 3:</td>
                            <td><span id="avg-current-value-phase-3">0.0</span> A</td>
                        </tr>
                    </table>
                </div>
                <div>
                    <ul>
                        <li>Motor start current: <span id="motor-start-current-value">0.0</span> A</li>
                        <li>Overload current: <span id="overload-current-value">0.0</span> A</li>
                    </ul>
                </div>
        </div>
        <div class="dashboard-item">
            <header>Voltage (Volt)</header>
                <div>
                    <p>Phase voltages active values:</p>
                    <ul>
                        <li>Phase1: <progress id="phase-1-voltage-bar" value="0" max="300"></progress> <span id="phase-1-voltage-value">0.0</span> V</li>
                        <li>Phase2: <progress id="phase-2-voltage-bar" value="0" max="300"></progress> <span id="phase-2-voltage-value">0.0</span> V</li>
                        <li>Phase3: <progress id="phase-3-voltage-bar" value="0" max="300"></progress> <span id="phase-3-voltage-value">0.0</span> V</li>
                    </ul>
                </div>
                <div>
                    <p>Line voltages active values:</p>
                    <ul>
                        <li>AB: <progress id="line-1-voltage-bar" value="0" max="475"></progress> <span id="line-1-voltage-value">0.0</span> V</li>
                        <li>BC: <progress id="line-2-voltage-bar" value="0" max="475"></progress> <span id="line-2-voltage-value">0.0</span> V</li>
                        <li>CA: <progress id="line-3-voltage-bar" value="0" max="475"></progress> <span id="line-3-voltage-value">0.0</span> V</li>
                    </ul>
                </div>

                <p>
                    Negative sequence voltage:
                    <div>
                        <progress id="negative-sequence-voltage-bar" value="0" max="300"></progress> <span id="negative-sequence-voltage-value">0.0</span> V
                    </div>
                </p>

                <p>
                    Positive sequence voltage: <span id="positive-sequence-voltage-value">0</span> V
                </p>
                <p>
                    Zero sequence voltage: <span id="zero-sequence-voltage-value">0</span> V
                </p>
        </div>
        <div class="dashboard-item">
            <header>Time (sec)</header>
                <div>
                    <p>Time before AR:</p>
                    <progress id="time-before-ar-bar" value="0" max="900"></progress> <span id="time-before-ar-string"> Off</span>
                </div>
                <ul>
                    <li>Startup time: <span id="startup-time-value">0</span> sec</li>
                    <li>Time before overload tripping: <span id="time-before-overload-tripping-string">No</span></li>
                    <li>Wait time after overload deenergize: <span id="wait-time-after-overload-deenergize-string">No</span></li>
                </ul>

                <header>Power</header>
                <ul>
                    <li>
                        <select id="power-characteristic-value-1" class="power-characteristic" name="power-characteristic-value-1">
                            <option value="full-power">Full power</option>
                            <option value="active-power">Active power</option>
                            <option value="reactive-power">Reactive power</option>
                            <option value="phase-1-full-power">Phase 1 full power</option>
                            <option value="phase-2-full-power">Phase 2 full power</option>
                            <option value="phase-3-full-power">Phase 3 full power</option>
                            <option value="phase-1-active-power">Phase 1 active power</option>
                            <option value="phase-2-active-power">Phase 2 active power</option>
                            <option value="phase-3-active-power">Phase 3 active power</option>
                            <option value="phase-1-reactive-power">Phase 1 reactive power</option>
                            <option value="phase-2-reactive-power">Phase 2 reactive power</option>
                            <option value="phase-3-reactive-power">Phase 3 reactive power</option>
                            <option value="phase-1-cos-phi">Phase 1 cos Phi</option>
                            <option value="phase-2-cos-phi">Phase 2 cos Phi</option>
                            <option value="phase-3-cos-phi">Phase 3 cos Phi</option>
                        </select>
                        <span id="power-show-value-1">
                            -
                        </span>
                    </li>
                    <li>
                        <select id="power-characteristic-value-2" class="power-characteristic" name="power-characteristic-value-2">
                            <option value="full-power">Full power</option>
                            <option value="active-power">Active power</option>
                            <option value="reactive-power">Reactive power</option>
                            <option value="phase-1-full-power">Phase 1 full power</option>
                            <option value="phase-2-full-power">Phase 2 full power</option>
                            <option value="phase-3-full-power">Phase 3 full power</option>
                            <option value="phase-1-active-power">Phase 1 active power</option>
                            <option value="phase-2-active-power">Phase 2 active power</option>
                            <option value="phase-3-active-power">Phase 3 active power</option>
                            <option value="phase-1-reactive-power">Phase 1 reactive power</option>
                            <option value="phase-2-reactive-power">Phase 2 reactive power</option>
                            <option value="phase-3-reactive-power">Phase 3 reactive power</option>
                            <option value="phase-1-cos-phi">Phase 1 cos Phi</option>
                            <option value="phase-2-cos-phi">Phase 2 cos Phi</option>
                            <option value="phase-3-cos-phi">Phase 3 cos Phi</option>
                        </select>
                        <span id="power-show-value-2">
                            -
                        </span>
                    </li>
                    <li>
                        <select id="power-characteristic-value-3" class="power-characteristic" name="power-characteristic-value-3">
                            <option value="full-power">Full power</option>
                            <option value="active-power">Active power</option>
                            <option value="reactive-power">Reactive power</option>
                            <option value="phase-1-full-power">Phase 1 full power</option>
                            <option value="phase-2-full-power">Phase 2 full power</option>
                            <option value="phase-3-full-power">Phase 3 full power</option>
                            <option value="phase-1-active-power">Phase 1 active power</option>
                            <option value="phase-2-active-power">Phase 2 active power</option>
                            <option value="phase-3-active-power">Phase 3 active power</option>
                            <option value="phase-1-reactive-power">Phase 1 reactive power</option>
                            <option value="phase-2-reactive-power">Phase 2 reactive power</option>
                            <option value="phase-3-reactive-power">Phase 3 reactive power</option>
                            <option value="phase-1-cos-phi">Phase 1 cos Phi</option>
                            <option value="phase-2-cos-phi">Phase 2 cos Phi</option>
                            <option value="phase-3-cos-phi">Phase 3 cos Phi</option>
                        </select>
                        <span id="power-show-value-3">
                            -
                        </span>
                    </li>
                </ul>
        </div>
        <div class="dashboard-item">
            <header>Additional</header>
                <ul>
                    <li>Sensor 1 temperature: <span id="sensor-1-temperature-value">Off</span></li>
                    <li>Sensor 2 temperature: <span id="sensor-2-temperature-value">Off</span></li>
                    <li>Current input: <span id="current-input-value">0.0</span> mA</li>
                    <li>Analog input: <span id="analog-input-value">0.0</span> V</li>
                    <li>Frequency: <span id="frequency-value">50.0</span> Hz</li>
                    <li>Insulation resistance: <span id="insulation-resistance-value">20.0</span> MOhm</li>
                </ul>
        </div>
    </div>
</div>
<!--        <footer>
            <button>Connect</button>
            <button>Database</button>
            <button>Settings</button>
            <button>UBZ Parameters</button>
            <button>Log event UBZ</button>
            <button>About</button>
        </footer>-->


<script type="text/javascript">
    var canvas = document.getElementById("heating-graph");
    var ctx = canvas.getContext("2d");
    ctx.font = "16px Droid Sans";
    ctx.strokeStyle = "green";
    ctx.strokeText("Graph here", 20, 20);
    
    const API_TOKEN = document.querySelector(".vis-view").getAttribute("apitoken");
    const API_BASE_URL = document.querySelector(".vis-view").getAttribute("apibaseurl");
    const CONTAINER = document.querySelector("#ubz-vis-container");
    const DEVICE_ID = CONTAINER.querySelector("alias").getAttribute("device").replace("#", "");
    
    async function regValues(address, registersNum) {
        const deviceInfo = await getResponse(`${API_BASE_URL}/v1/device/${DEVICE_ID}/`);

        const body = {
            deviceModbusId: deviceInfo.modbusUnitId,
            address: address,
            kind: "holding",
            registersNum: registersNum,
            connection: {
                kind: "net-id",
                networkId: deviceInfo.netId,
            }
        }

        const res = await postResponse(body,`${API_BASE_URL}/v1/raw/read-register-group/`);
        return res;
    }

    async function writeRegValues(address, values) {
        const deviceInfo = await getResponse(`${API_BASE_URL}/v1/device/${DEVICE_ID}/`);

        const body = {
            deviceModbusId: deviceInfo.modbusUnitId,
            address: address,
            kind: "holding",
            value: values,
            connection: {
                kind: "net-id",
                networkId: deviceInfo.netId,
            }
        }

        const res = await postResponse(body, `${API_BASE_URL}/v1/raw/write-register-group/`);
        return res;
    }

    async function updateVis() {
        const phaseRmsCurrentValues = await regValues(100, 3);
        document.querySelector("#phase-1-current-rms-value").innerHTML = (phaseRmsCurrentValues.ok[0] * 0.1).toFixed(1);
        document.querySelector("#phase-2-current-rms-value").innerHTML = (phaseRmsCurrentValues.ok[1] * 0.1).toFixed(1);
        document.querySelector("#phase-3-current-rms-value").innerHTML = (phaseRmsCurrentValues.ok[2] * 0.1).toFixed(1);
        document.querySelector("#phase-1-current-rms-bar").value = phaseRmsCurrentValues.ok[0];
        document.querySelector("#phase-2-current-rms-bar").value = phaseRmsCurrentValues.ok[1];
        document.querySelector("#phase-3-current-rms-bar").value = phaseRmsCurrentValues.ok[2];

        const zeroSequenceCurrentValue = await regValues(103, 1);
        document.querySelector("#zero-sequence-current-value").innerHTML = (zeroSequenceCurrentValue.ok[0] * 0.1).toFixed(1);
        document.querySelector("#zero-sequence-current-bar").value = zeroSequenceCurrentValue.ok[0];

        const currentAverageValues = await regValues(104, 3);
        document.querySelector("#avg-current-value-phase-1").innerHTML = (currentAverageValues.ok[0] * 0.1).toFixed(1);
        document.querySelector("#avg-current-value-phase-2").innerHTML = (currentAverageValues.ok[1] * 0.1).toFixed(1);
        document.querySelector("#avg-current-value-phase-3").innerHTML = (currentAverageValues.ok[2] * 0.1).toFixed(1); 

        const motorStartCurrentValue = await regValues(110, 1);
        document.querySelector("#motor-start-current-value").innerHTML = (motorStartCurrentValue.ok[0] * 0.1).toFixed(1);

        const overloadCurrentValue = await regValues(112, 1);
        document.querySelector("#overload-current-value").innerHTML = (overloadCurrentValue.ok[0] * 0.1).toFixed(1);

        const negativeSequenceCurrentValue = await regValues(113, 1);
        document.querySelector("#negative-sequence-current-value").innerHTML = (negativeSequenceCurrentValue.ok[0] * 0.1).toFixed(1);
        document.querySelector("#negative-sequence-current-bar").value = negativeSequenceCurrentValue.ok[0];

        const currentAverageForTimeValue = await regValues(153, 1);
        document.querySelector("#current-average-for-time-value").innerHTML = currentAverageForTimeValue.ok[0];

        const phaseRmsVoltageValues = await regValues(114, 3);
        document.querySelector("#phase-1-voltage-value").innerHTML = phaseRmsVoltageValues.ok[0];
        document.querySelector("#phase-2-voltage-value").innerHTML = phaseRmsVoltageValues.ok[1];
        document.querySelector("#phase-3-voltage-value").innerHTML = phaseRmsVoltageValues.ok[2];
        document.querySelector("#phase-1-voltage-bar").value = phaseRmsVoltageValues.ok[0];
        document.querySelector("#phase-2-voltage-bar").value = phaseRmsVoltageValues.ok[1];
        document.querySelector("#phase-3-voltage-bar").value = phaseRmsVoltageValues.ok[2];

        const lineVoltageValues = await regValues(117, 3);
        document.querySelector("#line-1-voltage-value").innerHTML = lineVoltageValues.ok[0];
        document.querySelector("#line-2-voltage-value").innerHTML = lineVoltageValues.ok[1];
        document.querySelector("#line-3-voltage-value").innerHTML = lineVoltageValues.ok[2];
        document.querySelector("#line-1-voltage-bar").value = lineVoltageValues.ok[0];
        document.querySelector("#line-2-voltage-bar").value = lineVoltageValues.ok[1];
        document.querySelector("#line-3-voltage-bar").value = lineVoltageValues.ok[2];

        const positiveSequenceVoltageValue = await regValues(120, 1);
        document.querySelector("#positive-sequence-voltage-value").innerHTML = positiveSequenceVoltageValue.ok[0];

        const negativeSequenceVoltageValue = await regValues(121, 1);
        document.querySelector("#negative-sequence-voltage-value").innerHTML = negativeSequenceVoltageValue.ok[0];
        document.querySelector("#negative-sequence-voltage-bar").value = negativeSequenceVoltageValue.ok[0];

        const zeroSequenceVoltageValue = await regValues(122, 1);
        document.querySelector("#zero-sequence-voltage-value").innerHTML = zeroSequenceVoltageValue.ok[0];

        const sensorTemperatureValues = await regValues(123, 2);
        document.querySelector("#sensor-1-temperature-value").innerHTML = temperatureSensorReadable(sensorTemperatureValues.ok[0]);
        document.querySelector("#sensor-2-temperature-value").innerHTML = temperatureSensorReadable(sensorTemperatureValues.ok[1]);

        const frequencyValue = await regValues(128, 1);
        document.querySelector("#frequency-value").innerHTML = (frequencyValue.ok[0] * 0.1).toFixed(1);

        const insulationResistanceValue = await regValues(132, 1);
        document.querySelector("#insulation-resistance-value").innerHTML = (insulationResistanceValue.ok[0] * 0.1).toFixed(1);

        const currentInputValue = await regValues(125, 1);
        document.querySelector("#current-input-value").innerHTML = (currentInputValue.ok[0] * 0.01).toFixed(2);

        const analogInputValue = await regValues(126, 1);
        document.querySelector("#analog-input-value").innerHTML = (analogInputValue.ok[0] * 0.1).toFixed(1);

        const timeBeforeArValue = await regValues(130, 1);
        if (timeBeforeArValue.ok[0] == 0) {
            document.querySelector("#time-before-ar-string").innerHTML = "Off";
            document.querySelector("#time-before-ar-bar").value = 0;
        } else if (timeBeforeArValue.ok[0] > 0 && timeBeforeArValue.ok[0] <= 900) {
            document.querySelector("#time-before-ar-string").innerHTML = timeBeforeArValue.ok[0].toString();
            document.querySelector("#time-before-ar-bar").value = timeBeforeArValue.ok[0];
        } else if (timeBeforeArValue.ok[0] == 950) {
            document.querySelector("#time-before-ar-string").innerHTML = "No AR";
            document.querySelector("#time-before-ar-bar").value = 0;
        } else {
            document.querySelector("#time-before-ar-string").innerHTML = "???";
            document.querySelector("#time-before-ar-bar").value = 0;
        }

        const relayWorkModeValue = await regValues(205, 1);
        if (relayWorkModeValue.ok[0] == 0) {
            document.querySelector("#radio-workmode-alarm").checked = true;
        } else if (relayWorkModeValue.ok[0] == 1) {
            document.querySelector("#radio-workmode-time").checked = true;
        } else if (relayWorkModeValue.ok[0] == 2) {
            document.querySelector("#radio-workmode-stardelta").checked = true;
        }
    }

    updateVis();

    // TODO: affect only when changed
    document.querySelector("#radio-workmode-alarm").addEventListener("click", async function() {
        console.log(await writeRegValues(205, [0]));
    })

    document.querySelector("#radio-workmode-time").addEventListener("click", async function () {
        console.log(await writeRegValues(205, [1]));
    })

    document.querySelector("#radio-workmode-stardelta").addEventListener("click", async function () {
        console.log(await writeRegValues(205, [2]));
    })

    function sinFromCos(cosValue) {
        return Math.sqrt(1 - Math.pow(cosValue, 2));
    }

    async function showPowerCharacteristicByKey(keystring) {
        var outstring = "Unknown";
        switch (keystring) {
            case "full-power":
                const fullPowerValue = await regValues(135, 1);
                console.log(fullPowerValue);
                const fullPower = fullPowerValue.ok[0] * 0.01;
                outstring = fullPower.toString();
                break;
            case "active-power":
                const activePowerValue = await regValues(137, 1);
                const activePower = activePowerValue.ok[0] * 0.01;
                outstring = activePower.toString();
                break;
            case "reactive-power":
                const reactivePowerValue = await regValues(139, 1);
                const reactivePower = reactivePowerValue.ok[0] * 0.01;
                outstring = reactivePower.toString();
                break;
            case "phase-1-full-power":
                {
                    const RMSVoltagePhase1Value = await regValues(114, 1);
                    const RMSVoltagePhase1 = RMSVoltagePhase1Value.ok[0];
                    const RMSCurrentPhase1Value = await regValues(100, 1);
                    const RMSCurrentPhase1 = RMSCurrentPhase1Value.ok[0] * 0.1;
                    const phase1FullPower = RMSVoltagePhase1Value * RMSCurrentPhase1;
                    outstring = phase1FullPower.toString();
                }
                break;
            case "phase-2-full-power":
                {
                    const RMSVoltagePhase2Value = await regValues(115, 1);
                    const RMSVoltagePhase2 = RMSVoltagePhase2Value.ok[0];
                    const RMSCurrentPhase2Value = await regValues(101, 1);
                    const RMSCurrentPhase2 = RMSCurrentPhase2Value.ok[0] * 0.1;
                    const phase2FullPower = RMSVoltagePhase2Value * RMSCurrentPhase2;
                    outstring = phase2FullPower.toString();
                }
                break;
            case "phase-3-full-power":
                {
                    const RMSVoltagePhase3Value = await regValues(116, 1);
                    const RMSVoltagePhase3 = RMSVoltagePhase3Value.ok[0];
                    const RMSCurrentPhase3Value = await regValues(102, 1);
                    const RMSCurrentPhase3 = RMSCurrentPhase3Value.ok[0] * 0.1;
                    const phase3FullPower = RMSVoltagePhase3Value * RMSCurrentPhase3;
                    outstring = phase3FullPower.toString();
                }
                break;
            case "phase-1-active-power":
                {
                    const RMSVoltagePhase1Value = await regValues(114, 1);
                    const RMSVoltagePhase1 = RMSVoltagePhase1Value.ok[0];
                    const RMSCurrentPhase1Value = await regValues(100, 1);
                    const RMSCurrentPhase1 = RMSCurrentPhase1Value.ok[0] * 0.1;
                    const cosPhiPhase1Value = await regValues(141, 1);
                    const cosPhiPhase1 = cosPhiPhase1Value.ok[0] * 0.001;
                    const phase1activePower = RMSVoltagePhase1Value * RMSCurrentPhase1 * cosPhiPhase1;
                    outstring = phase1activePower.toString();
                }
                break;
            case "phase-2-active-power":
                {
                    const RMSVoltagePhase2Value = await regValues(115, 1);
                    const RMSVoltagePhase2 = RMSVoltagePhase2Value.ok[0];
                    const RMSCurrentPhase2Value = await regValues(101, 1);
                    const RMSCurrentPhase2 = RMSCurrentPhase2Value.ok[0] * 0.1;
                    const cosPhiPhase2Value = await regValues(143, 1);
                    const cosPhiPhase2 = cosPhiPhase2Value.ok[0] * 0.001;
                    const phase2activePower = RMSVoltagePhase2Value * RMSCurrentPhase2 * cosPhiPhase2;
                    outstring = phase2activePower.toString();
                }
                break;
            case "phase-3-active-power":
               {
                    const RMSVoltagePhase3Value = await regValues(116, 1);
                    const RMSVoltagePhase3 = RMSVoltagePhase3Value.ok[0];
                    const RMSCurrentPhase3Value = await regValues(102, 1);
                    const RMSCurrentPhase3 = RMSCurrentPhase3Value.ok[0] * 0.1;
                    const cosPhiPhase3Value = await regValues(145, 1);
                    const cosPhiPhase3 = cosPhiPhase3Value.ok[0] * 0.001;
                    const phase3activePower = RMSVoltagePhase3Value * RMSCurrentPhase3 * cosPhiPhase3;
                    outstring = phase3activePower.toString();
                }
                break;
            case "phase-1-reactive-power":
                {
                    const RMSVoltagePhase1Value = await regValues(114, 1);
                    const RMSVoltagePhase1 = RMSVoltagePhase1Value.ok[0];
                    const RMSCurrentPhase1Value = await regValues(100, 1);
                    const RMSCurrentPhase1 = RMSCurrentPhase1Value.ok[0] * 0.1;
                    const cosPhiPhase1Value = await regValues(141, 1);
                    const cosPhiPhase1 = cosPhiPhase1Value.ok[0] * 0.001;
                    const sinPhiPhase1 = sinFromCos(cosPhiPhase1);
                    const phase1reactivePower = RMSVoltagePhase1Value * RMSCurrentPhase1 * sinPhiPhase1;
                    outstring = phase1reactivePower.toString();
                }
                
                break;
            case "phase-2-reactive-power":
                {
                    const RMSVoltagePhase2Value = await regValues(115, 1);
                    const RMSVoltagePhase2 = RMSVoltagePhase2Value.ok[0];
                    const RMSCurrentPhase2Value = await regValues(101, 1);
                    const RMSCurrentPhase2 = RMSCurrentPhase2Value.ok[0] * 0.1;
                    const cosPhiPhase2Value = await regValues(143, 1);
                    const cosPhiPhase2 = cosPhiPhase2Value.ok[0] * 0.001;
                    const sinPhiPhase2 = sinFromCos(cosPhiPhase2);
                    const phase2reactivePower = RMSVoltagePhase2Value * RMSCurrentPhase2 * sinPhiPhase2;
                    outstring = phase2reactivePower.toString();
                }
                break;
            case "phase-3-reactive-power":
                {
                    const RMSVoltagePhase3Value = await regValues(116, 1);
                    const RMSVoltagePhase3 = RMSVoltagePhase3Value.ok[0];
                    const RMSCurrentPhase3Value = await regV3lues(102, 1);
                    const RMSCurrentPhase3 = RMSCurrentPhase3Value.ok[0] * 0.1;
                    const cosPhiPhase3Value = await regValue3(145, 1);
                    const cosPhiPhase3 = cosPhiPhase3Value.ok[0] * 0.001;
                    const sinPhiPhase3 = sinFromCos(cosPhiPhase3);
                    const phase3reactivePower = RMSVoltagePhase3Value * RMSCurrentPhase3 * sinPhiPhase3;
                    outstring = phase3reactivePower.toString();
                }
                break;
            case "phase-1-cos-phi":
                {
                    const cosPhiPhase1Value = await regValues(141, 1);
                    const cosPhiPhase1 = cosPhiPhase1Value.ok[0] * 0.001;
                    outstring = cosPhiPhase1.toFixed(3);
                }
                break;
            case "phase-2-cos-phi":
                {
                    const cosPhiPhase2Value = await regValues(143, 1);
                    const cosPhiPhase2 = cosPhiPhase2Value.ok[0] * 0.001;
                    outstring = cosPhiPhase2.toFixed(3);
                }
                break;
            case "phase-3-cos-phi":
                {
                    const cosPhiPhase3Value = await regValues(145, 1);
                    const cosPhiPhase3 = cosPhiPhase3Value.ok[0] * 0.001;
                    outstring = cosPhiPhase3.toFixed(3);
                }
                break;
        }
        return outstring;
    }

    document.querySelector("#power-characteristic-value-1").addEventListener("change", async function () {
        console.log("changed field 1");
        const outstring = await showPowerCharacteristicByKey(document.querySelector("#power-characteristic-value-1").value);
        document.querySelector("#power-show-value-1").innerHTML = outstring;
    })

    document.querySelector("#power-characteristic-value-2").addEventListener("change", async function () {
        console.log("changed field 2");
        const outstring = await showPowerCharacteristicByKey(document.querySelector("#power-characteristic-value-2").value);
        document.querySelector("#power-show-value-2").innerHTML = outstring;
    })

    document.querySelector("#power-characteristic-value-3").addEventListener("change", async function () {
        console.log("changed field 3");
        const outstring = await showPowerCharacteristicByKey(document.querySelector("#power-characteristic-value-3").value);
        document.querySelector("#power-show-value-3").innerHTML = outstring;
    })

    function temperatureSensorReadable(value) {
        if (value == 5000) {
            return "Off";
        } else if (value <= 2010 && value >= 1990) {
            return "Fault";
        } else if (value <= 1010 && value >= 990) {
            return "S/C"
        } else if (value <= 220 && value >= -40) {
            return String(value);
        } else {
            return "Und.";
        }
    }
    
    async function postResponse(body, url) {
        const res = await new Promise((resolve, reject) => {
            const request = new XMLHttpRequest();
            request.onload = function() {
                const data = JSON.parse(request.response);
                resolve(data);
            }

            request.onerror = function(err) {
                console.error(err);
                reject(err)
            }

            request.open("POST", url);
            request.setRequestHeader("authorization", `token ${API_TOKEN}`);
            request.setRequestHeader("Content-Type", "application/json");
            request.send(JSON.stringify(body));
        });

        return res;
    }

    async function getResponse(url) {
        const res = await new Promise((resolve, reject) => {
            const request = new XMLHttpRequest();
            request.onload = function() {
                const data = JSON.parse(request.response);
                resolve(data);
            }

            request.onerror = function(err) {
                console.error(err);
                reject(err)
            }

            request.open("GET", url);
            request.setRequestHeader("authorization", `token ${API_TOKEN}`);
            request.setRequestHeader("Content-Type", "application/json");
            request.send();
        });

        return res;
    }
</script>
